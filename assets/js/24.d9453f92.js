(window.webpackJsonp=window.webpackJsonp||[]).push([[24],{483:function(s,a,t){s.exports=t.p+"assets/img/image-20200225155547026.0af6c4d9.png"},484:function(s,a,t){s.exports=t.p+"assets/img/image-20200225205700001.14b2da22.png"},618:function(s,a,t){"use strict";t.r(a);var n=t(16),e=Object(n.a)({},(function(){var s=this,a=s.$createElement,n=s._self._c||a;return n("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[n("h1",{attrs:{id:"用户的特殊-shell-与-pam-模块"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#用户的特殊-shell-与-pam-模块"}},[s._v("#")]),s._v(" 用户的特殊 shell 与 PAM 模块")]),s._v(" "),n("p",[s._v("前面讲解的大多是一般身份用户与系统管理员 root 的相关操作，而且大多是关于可登陆系统的账户来说的。")]),s._v(" "),n("p",[s._v("那么想要建立一个 "),n("strong",[s._v("仅仅能使用 mail server 相关邮件服务的账户，而该账户并不能登陆 Linux 主机")]),s._v("，如果分配密码则")]),s._v(" "),n("p",[s._v("另外 前面说"),n("code",[s._v("/etc/login.defs")]),s._v("文件中，关于密码长度默认是 5 个字符串长度，但是该值以及被 PAM 模块所取代了，那么 PAM 是什么？为什么他可以影响我们使用者的登录呢？")]),s._v(" "),n("h2",{attrs:{id:"特殊的-shell：-sbin-nologin"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#特殊的-shell：-sbin-nologin"}},[s._v("#")]),s._v(" 特殊的 shell："),n("code",[s._v("/sbin/nologin")])]),s._v(" "),n("p",[s._v("在 passwd 文件结构里面有看到过这个 shell 的配置，如果配置了这个 shell 给一个账户，那么该账户试图登录的时候，就会提示如下的信息")]),s._v(" "),n("div",{staticClass:"language-bash line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[s._v("This account is currently not available\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])]),n("p",[s._v("这里说的无法登录仅表示：这个使用者无法使用 bash 或其他 shell 来登录系统，并不是说无法使用其他系统资源")]),s._v(" "),n("p",[s._v("那么上面的提示内容，仅仅提示该账户目前不可用，其实可以通过 "),n("code",[s._v("/etc/nologin.txt")]),s._v(" 文件来自定义提示内容")]),s._v(" "),n("div",{staticClass:"language-bash line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 利用纯 mail 账户，例如 myuser3 时，显示自定义内容给登陆者查看")]),s._v("\n\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@study ~"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# vim /etc/nologin.txt")]),s._v("\n 该账户只用来接收邮件，不提供登录服务。\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 之前创建 myuser3 的时候 shell 就设置的是 /sbin/nologin")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("pro2@study ~"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("$ "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("su")]),s._v(" -l myuser3\nPassword: \n该账户只用来接收邮件，不提供登录服务。\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 可以看到提示信息就被自定义了")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br")])]),n("h2",{attrs:{id:"pam-模块简介"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#pam-模块简介"}},[s._v("#")]),s._v(" PAM 模块简介")]),s._v(" "),n("p",[s._v("PAM（Pluggable Authentication Modules 嵌入式模块）可以说是一套应用程序编程接口，提供了许多验证机制，只要使用者将验证阶段的需求告知 PAM 后，PAM 就能返回验证结果成功或失败。")]),s._v(" "),n("p",[s._v("没有用 PAM 之前，需要自己写程序处理账户密码的验证，那么就有人收集了很多验证需求实现后提供了一个验证模块。因此程序都可以引用该模块来进行验证")]),s._v(" "),n("p",[n("img",{attrs:{src:t(483),alt:"image-20200225155547026"}})]),s._v(" "),n("p",[s._v("如图示，PAM 是一个独立的 API，你的程序也可以引入他来进行验证")]),s._v(" "),n("p",[s._v("PAM 用来进行验证的数据成为模块（Modules），每个 PAM 模块功能都不太相同，比如，之前 passwd 指令输入密码，报错提示在字典上面找到的字符串，这是 PAM 的 pam_cracklib.so 模块的功能")]),s._v(" "),n("h2",{attrs:{id:"pam-模块设置语法"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#pam-模块设置语法"}},[s._v("#")]),s._v(" PAM 模块设置语法")]),s._v(" "),n("p",[s._v("这里以  passwd 指令调用的 PAM 来说明：")]),s._v(" "),n("ol",[n("li",[s._v("用户开始执行 "),n("code",[s._v("/usr/bin/passwd")]),s._v(" 程序，并输入密码")]),s._v(" "),n("li",[s._v("passwd 调用 PAM 模块进行验证")]),s._v(" "),n("li",[s._v("PAM 模块会到 "),n("code",[s._v("/etc/pam.d/")]),s._v(" 寻找与指令 passwd 同名的配置文件")]),s._v(" "),n("li",[s._v("根据 "),n("code",[s._v("/etc/pam.d/passwd")]),s._v(" 内的设置，引用相关的 PAM 模块逐步进行验证分析；")])]),s._v(" "),n("p",[s._v("那么从这里就看出来了，他的入口配置是：")]),s._v(" "),n("ol",[n("li",[s._v("配置文件要放到 "),n("code",[s._v("/etc/pam.d/")]),s._v(" 中，且同名")]),s._v(" "),n("li",[s._v("程序要调用")])]),s._v(" "),n("p",[s._v("下面先来看看配置文件的内容。")]),s._v(" "),n("div",{staticClass:"language-bash line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("pro2@study ~"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("$ "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("cat")]),s._v(" /etc/pam.d/passwd \n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#%PAM-1.0\t\t# PAM 版本说明")]),s._v("\nauth       include\tsystem-auth\t\t\t"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 每一行是一个验证程序")]),s._v("\naccount    include\tsystem-auth\npassword   substack\tsystem-auth\n-password   optional\tpam_gnome_keyring.so use_authtok\npassword   substack\tpostlogin\n验证类别\t控制标准\tPAM 模块与该模块的参数\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br")])]),n("p",[s._v("该文件中，除了第一行声明  PAM 版本外，其他的 "),n("code",[s._v("#")]),s._v(" 开头的均为批注内容")]),s._v(" "),n("p",[s._v("上面第 2 字段中出现的 include 是标识，调用后面的文件来作为这个类别的验证，所以是调用 "),n("code",[s._v("/etc/pam.d/system-auth")]),s._v(" 文件来进行验证")]),s._v(" "),n("ol",[n("li",[n("p",[s._v("验证类别（type）：主要分为 4 种")]),s._v(" "),n("ul",[n("li",[n("p",[s._v("auth：authentication 认证")]),s._v(" "),n("p",[s._v("主要用来校验使用者的身份验证，这种类别通常是需要密码来校验的，所以后续接的模块是用来校验用户的身份")])]),s._v(" "),n("li",[n("p",[s._v("account：account 账户")]),s._v(" "),n("p",[s._v("大部分是在进行 authorization 授权，这种类别主要检验使用者是否具有正确的权限，比如：使用一个过期的密码来登录，就无法登录了")])]),s._v(" "),n("li",[n("p",[s._v("session")]),s._v(" "),n("p",[s._v("该使用者在此次登录（或使用这个指令）期间，PAM 所给予的环境设置。这个类别通常用在记录用户登录与注销时的信息。")]),s._v(" "),n("p",[s._v("例如：假如你常常使用 su 或 sudo 指令，那么应该可以在 "),n("code",[s._v("/var/log/secure")]),s._v(" 里面发现很多关于 pam 的说明，而且记载的数据是"),n("code",[s._v("session open、session close")]),s._v(" 的信息")])]),s._v(" "),n("li",[n("p",[s._v("password 密码")]),s._v(" "),n("p",[s._v("主要提供验证的修改工作，比如修改密码")])])]),s._v(" "),n("p",[s._v("这 4 个验证类型通常是有顺序的（也有例外），有顺序是因为：")]),s._v(" "),n("ol",[n("li",[s._v("总是要先验证身份（auth）后")]),s._v(" "),n("li",[s._v("系统才能够获取到用户身份给予适当的授权与权限设置（account）")]),s._v(" "),n("li",[s._v("登录与注销期间的环境才需要设置，需要记录登录与注销信息 （session）")]),s._v(" "),n("li",[s._v("修改密码时，使用 password 类别")])]),s._v(" "),n("p",[s._v("根据业务来看，貌似是有必要有顺序的")])]),s._v(" "),n("li",[n("p",[s._v("验证的控制旗标（control flag）")]),s._v(" "),n("p",[s._v("简单说：是验证通过的标准，主要有 4 种控制方式")]),s._v(" "),n("ul",[n("li",[n("p",[s._v("required")]),s._v(" "),n("p",[s._v("验证成功则带有 success 标志，失败则 failure 标志，但是都会继续后续的验证流程")])]),s._v(" "),n("li",[n("p",[s._v("requisite")]),s._v(" "),n("p",[s._v("若验证失败立刻返回 failure 标志，并终止后续的验证流程。若验证成功则带有 success 标志，并继续后续的验证流程。")]),s._v(" "),n("p",[s._v("由于失败就终止，因此失败时所产生的 PAM 信息无法通过后续的模块来记录了")])]),s._v(" "),n("li",[n("p",[s._v("sufficient")]),s._v(" "),n("p",[s._v("若验证成功立刻回传 success 给原程序，并终止后续验证流程；")]),s._v(" "),n("p",[s._v("若验证失败则带有 failure 标志并继续后续的验证流程。与 requisite 相反")])]),s._v(" "),n("li",[n("p",[s._v("optional")]),s._v(" "),n("p",[s._v("该模块控件大多数是显示信息，并不是用在验证方面")])])]),s._v(" "),n("p",[s._v("图示如下：")]),s._v(" "),n("p",[n("img",{attrs:{src:t(484),alt:"image-20200225205700001"}})])])]),s._v(" "),n("h2",{attrs:{id:"常用模块简介"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#常用模块简介"}},[s._v("#")]),s._v(" 常用模块简介")]),s._v(" "),n("p",[s._v("由于常常需要通过各种方式来登录 login 系统，来看看登录所需要的 PAM 流程：")]),s._v(" "),n("div",{staticClass:"language-bash line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("mrcode@study ~"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("$ "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("cat")]),s._v(" /etc/pam.d/login \n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#%PAM-1.0")]),s._v("\nauth "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("user_unknown"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("ignore "),n("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("success")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("ok "),n("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("ignore")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("ignore "),n("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("default")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("bad"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" pam_securetty.so\nauth       substack     system-auth\nauth       include      postlogin\naccount    required     pam_nologin.so\naccount    include      system-auth\npassword   include      system-auth\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# pam_selinux.so close should be the first session rule")]),s._v("\nsession    required     pam_selinux.so close\nsession    required     pam_loginuid.so\nsession    optional     pam_console.so\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# pam_selinux.so open should only be followed by sessions to be executed in the user context")]),s._v("\nsession    required     pam_selinux.so "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("open")]),s._v("\nsession    required     pam_namespace.so\nsession    optional     pam_keyinit.so force revoke\nsession    include      system-auth\nsession    include      postlogin\n-session   optional     pam_ck_connector.so\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 这里看到最多的应该是有引用了 system-auth，来观察下")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("mrcode@study ~"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("$ "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("cat")]),s._v(" /etc/pam.d/system-auth\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#%PAM-1.0")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# This file is auto-generated.")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# User changes will be destroyed the next time authconfig is run.")]),s._v("\nauth        required      pam_env.so\nauth        required      pam_faildelay.so "),n("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("delay")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("2000000")]),s._v("\nauth        sufficient    pam_fprintd.so\nauth        sufficient    pam_unix.so nullok try_first_pass\nauth        requisite     pam_succeed_if.so uid "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("1000")]),s._v(" quiet_success\nauth        required      pam_deny.so\n\naccount     required      pam_unix.so\naccount     sufficient    pam_localuser.so\naccount     sufficient    pam_succeed_if.so uid "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("1000")]),s._v(" quiet\naccount     required      pam_permit.so\n\npassword    requisite     pam_pwquality.so try_first_pass local_users_only "),n("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("retry")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("authtok_type")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("\npassword    sufficient    pam_unix.so sha512 shadow nullok try_first_pass use_authtok\npassword    required      pam_deny.so\n\nsession     optional      pam_keyinit.so revoke\nsession     required      pam_limits.so\n-session     optional      pam_systemd.so\nsession     "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("success"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("default")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("ignore"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" pam_succeed_if.so "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("service")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("in")]),s._v(" crond quiet use_uid\nsession     required      pam_unix.so\n\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br"),n("span",{staticClass:"line-number"},[s._v("22")]),n("br"),n("span",{staticClass:"line-number"},[s._v("23")]),n("br"),n("span",{staticClass:"line-number"},[s._v("24")]),n("br"),n("span",{staticClass:"line-number"},[s._v("25")]),n("br"),n("span",{staticClass:"line-number"},[s._v("26")]),n("br"),n("span",{staticClass:"line-number"},[s._v("27")]),n("br"),n("span",{staticClass:"line-number"},[s._v("28")]),n("br"),n("span",{staticClass:"line-number"},[s._v("29")]),n("br"),n("span",{staticClass:"line-number"},[s._v("30")]),n("br"),n("span",{staticClass:"line-number"},[s._v("31")]),n("br"),n("span",{staticClass:"line-number"},[s._v("32")]),n("br"),n("span",{staticClass:"line-number"},[s._v("33")]),n("br"),n("span",{staticClass:"line-number"},[s._v("34")]),n("br"),n("span",{staticClass:"line-number"},[s._v("35")]),n("br"),n("span",{staticClass:"line-number"},[s._v("36")]),n("br"),n("span",{staticClass:"line-number"},[s._v("37")]),n("br"),n("span",{staticClass:"line-number"},[s._v("38")]),n("br"),n("span",{staticClass:"line-number"},[s._v("39")]),n("br"),n("span",{staticClass:"line-number"},[s._v("40")]),n("br"),n("span",{staticClass:"line-number"},[s._v("41")]),n("br"),n("span",{staticClass:"line-number"},[s._v("42")]),n("br"),n("span",{staticClass:"line-number"},[s._v("43")]),n("br"),n("span",{staticClass:"line-number"},[s._v("44")]),n("br"),n("span",{staticClass:"line-number"},[s._v("45")]),n("br"),n("span",{staticClass:"line-number"},[s._v("46")]),n("br"),n("span",{staticClass:"line-number"},[s._v("47")]),n("br")])]),n("p",[s._v("system-auth 用到了非常多的 PAM 模块，每个模块的功能都不太相同，详细的模块数据可以在以下位置找到：")]),s._v(" "),n("ul",[n("li",[n("code",[s._v("/etc/pam.d/*")]),s._v("：每个程序个别的 PAM 配置文件")]),s._v(" "),n("li",[n("code",[s._v("/lib64/security/*")]),s._v("：PAM 模块文件的实际放置目录")]),s._v(" "),n("li",[n("code",[s._v("/etc/security/*")]),s._v("：其他 PAM 环境的配置文件")]),s._v(" "),n("li",[n("code",[s._v("/usr/share/doc/pam-*")]),s._v("：详细的 PAM 说明文件")])]),s._v(" "),n("div",{staticClass:"language-bash line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@study ~"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# find / -name *.pam_nologin")]),s._v("\n/usr/share/doc/pam-1.1.8/txts/README.pam_nologin\n比如 pam_nologin.so 的说明文件，就在以上路径，可以阅读下\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br")])]),n("p",[s._v("下面介绍几个常用的模块，详细的信息需要自己去查阅资料")]),s._v(" "),n("ul",[n("li",[n("p",[s._v("pam_securetty.so：限制系统管理员 root 只能怪从安全的 secure 终端机登录")]),s._v(" "),n("p",[s._v("例如 tty1、tty2 就是传统的终端机装置名称。安全的终端机设置在 "),n("code",[s._v("/etc/securetty")]),s._v(" 文件中，里面列出了终端机名称，查看下就知道为什么 root 可以从 tty1~tt2 登录，而不能通过 telnet 登录了")])]),s._v(" "),n("li",[n("p",[s._v("pam_nologin.so：可以限制一般用户是否能够登录主机")]),s._v(" "),n("p",[s._v("当 "),n("code",[s._v("/etc/nologin")]),s._v(" 文件存在时，则所有一般使用者均无法再登录系统了，并在他们的终端机上会将该文件内容显示出来；")]),s._v(" "),n("p",[s._v("正常情况下，该文件是不能存在系统中的，该模块对 root 以及已经登录系统中的一般账户没有影响。注意：该文件与 "),n("code",[s._v("/etc/nologin.txt")]),s._v(" 不是同一个")])]),s._v(" "),n("li",[n("p",[s._v("pam_selinux.so：SELinux 是个针对程序来进行细部管理权限的功能")]),s._v(" "),n("p",[s._v("在后续的第 16 章中再来讨论 SELinux。由于 SELinux 会影响到用户执行程序的权限，因此利用 PAM 模块，将 SELinux 暂时关闭，等到验证通过后，在启动")])]),s._v(" "),n("li",[n("p",[s._v("pam_console.so：")]),s._v(" "),n("p",[s._v("当系统出现某些问题，或则是需要使用特殊的终端接口（如 RS232 之类的终端机联机设备）登录主机时，该模块可以帮助处理一些文件权限问题，让使用者可以通过特殊终端接口 console 顺利登录系统")])]),s._v(" "),n("li",[n("p",[s._v("pam_loginuid.so：")]),s._v(" "),n("p",[s._v("系统账户与一般账户的 UID 不同的，一般账户 UID 均大于 1000 才合理。可以用该模块来验证使用者的 UID 是否符合要求")])]),s._v(" "),n("li",[n("p",[s._v("pam_unix.so：")]),s._v(" "),n("p",[s._v("很复杂的且重要的模块，可以用在验证阶段的认证功能，可以用在授权阶段的账户许可证管理，可以用在会议（session）阶段的登录文件记录，甚至可以用在密码更新阶段的校验。该模块在早期用的较多")])]),s._v(" "),n("li",[n("p",[s._v("pam_pwquality.so：")]),s._v(" "),n("p",[s._v("可以用来校验密码强度，包括是否在字典中、密码输入几次都失败就断掉此次联机等功能。")]),s._v(" "),n("p",[s._v("最早使用的是 pam_cracklib.so 模块，后来改成 pam_pwquality.so 模块，pam_pwquality.so 兼容 pam_cracklib.so 模块，同时提供了 "),n("code",[s._v("/etc/security/pwquality.conf")]),s._v(" 文件可以额外指定默认值，比较容易处理修改")])]),s._v(" "),n("li",[n("p",[s._v("pam_limits.so")]),s._v(" "),n("p",[s._v("在第 10 章中讲解的 ulimit，就是该模块提供的能力，更多信息可以查看 "),n("code",[s._v("/etc/security/limits.conf")])])])]),s._v(" "),n("p",[s._v("了解了模块大致功能后，这里讨论下 login 的 PAM 验证机制流程：")]),s._v(" "),n("ol",[n("li",[s._v("验证阶段 auth：\n"),n("ol",[n("li",[s._v("经过 pam_securetty.so ，如果使用者是 root 时，会参考 /etc/securetty 的设置")]),s._v(" "),n("li",[s._v("经过 pam_env.so 设置额外的环境变量")]),s._v(" "),n("li",[s._v("经过 pam_unix.so 校验密码，若通过则回报 login 程序")]),s._v(" "),n("li",[s._v("若未通过，则继续往下以 pam_succeed_if.so 判断 UID 是大于 1000，若小于 1000 则回报失败")]),s._v(" "),n("li",[s._v("若大于 1000 则以 pam_deny.so 拒绝联机")])])]),s._v(" "),n("li",[s._v("授权阶段 account：\n"),n("ol",[n("li",[s._v("以 pam_nologin.so 判断 /etc/nologin 是否存在，若存在则不允许一般使用者登录")]),s._v(" "),n("li",[s._v("接下来以 pam_unix.so 及 pam_localuser.so 进行账户管理")]),s._v(" "),n("li",[s._v("再以 pam_succeed_if.so 判断 UID 是否小于 1000，若小于 1000 则不记录登录信息")]),s._v(" "),n("li",[s._v("最后已 pam_permit.so 允许该账户登录")])])]),s._v(" "),n("li",[s._v("密码阶段 password：\n"),n("ol",[n("li",[s._v("以 pam_pwauality.so 设置密码仅能尝试错误 3 次")]),s._v(" "),n("li",[s._v("接下来以 pam_unix.so 通过 sha512 shadow 等功能进行密码校验，若通过则回报 login 程序")]),s._v(" "),n("li",[s._v("若不通过则以 pam_deny.so 聚焦登录")])])]),s._v(" "),n("li",[s._v("会议阶段 session：\n"),n("ol",[n("li",[s._v("以 pam_selinux.so 暂时关闭 SELinux")]),s._v(" "),n("li",[s._v("使用 pam_limits.so 设置好用户能够操作的系统资源")]),s._v(" "),n("li",[s._v("登录成功后开始记录相关信息在登录文件中")]),s._v(" "),n("li",[s._v("以 pam_loginuid.so 规范不同的 UID 权限")]),s._v(" "),n("li",[s._v("开启 pam_selinux.so 功能")])])])]),s._v(" "),n("p",[s._v("这小节感觉太难了，笔者没有看懂也联想不到，只知道 /etc/nologin 文件存在的话，一般使用者都不能登录，远程联机有可能无法使用 root 登录，这些都是 PAM 模块提供的功能")]),s._v(" "),n("h2",{attrs:{id:"其他相关文件"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#其他相关文件"}},[s._v("#")]),s._v(" 其他相关文件")]),s._v(" "),n("p",[s._v("前面讲到：")]),s._v(" "),n("ul",[n("li",[n("code",[s._v("/etc/securetty")]),s._v(" 会影响到 root 可登录的安全终端机")]),s._v(" "),n("li",[n("code",[s._v("/etc/nologin")]),s._v(" 会影响到一般使用者是否能够登录")]),s._v(" "),n("li",[n("code",[s._v("/etc/pam.d")]),s._v(" 是 PAM 相关配置文件所在目录")]),s._v(" "),n("li",[n("code",[s._v("/usr/share/doc/pam-(版本)")]),s._v(" 是 PAM 说明文件所在目录")]),s._v(" "),n("li",[n("code",[s._v("/lib64/security")]),s._v(" 是 PAM 模块程序文件所在目录")])]),s._v(" "),n("p",[s._v("主要的 PAM 文件都在 "),n("code",[s._v("/etc/security")]),s._v(" 目录中，下面介绍几个可能会用到的配置文件")]),s._v(" "),n("h3",{attrs:{id:"limits-conf"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#limits-conf"}},[s._v("#")]),s._v(" limits.conf")]),s._v(" "),n("p",[n("RouterLink",{attrs:{to:"/tutorial-basis/13/10/02.html#与文件系统及程序的限制关系：ulimit"}},[s._v(" 第 10 章讲到的 ulimit 功能 ")]),s._v("，除了修改使用者的 "),n("code",[s._v("~/.bashrc")]),s._v(" 配置文件外，系统管理员可以通过 PAM 来管理，就是 "),n("code",[s._v("/etc/security/limits.conf")]),s._v(" 这个文件。这里做个简单介绍")],1),s._v(" "),n("div",{staticClass:"language-bash line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 范例 1：mrcode1 这个用户只能建立 100MB 的文件，且大于 90MB 会警告")]),s._v("\n\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@study ~"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# vim /etc/security/limits.conf ")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#<domain>      <type>  <item>         <value>")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#")]),s._v("\nmrcode1 soft    fsize   "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("90000")]),s._v("\nmrcode1 hard    fsize   "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("100000")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 账户\t限制类型\t限制项目\t限制值")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" 字段：账户或群组，若为群组则前面需要加上 @，例如 @projecta\n"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v(" 字段：类型，是严格 hard，还是仅警告 soft\n"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),s._v(" 字段：此例中是文件容量\n"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("4")]),s._v(" 字段：为限制值，在此列中单位为 KB\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 使用 mrcode1 登录后执行以下操作")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("mrcode1@study ~"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("$ "),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("ulimit")]),s._v(" -a\ncore "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("file")]),s._v(" size          "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("blocks, -c"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("\ndata seg size           "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("kbytes, -d"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" unlimited\nscheduling priority             "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("-e"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("file")]),s._v(" size               "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("blocks, -f"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("90000")]),s._v("\t\t"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 查看到这里限制变成了 90000")]),s._v("\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#尝试创建大于 90MB 的文件")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("mrcode1@study ~"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("$ "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("dd")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("if")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("/dev/zero "),n("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("of")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("test "),n("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("bs")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("1M "),n("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("count")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("110")]),s._v("\nFile size limit exceeded "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("core dumped"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("mrcode1@study ~"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("$ ll --block-size"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("K "),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("test")]),s._v("\n-rw-rw-r--. "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" mrcode1 mrcode1 90000K Feb "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("25")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("22")]),s._v(":07 "),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("test")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 发现该文件最多只有 90MB")]),s._v("\n\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br"),n("span",{staticClass:"line-number"},[s._v("22")]),n("br"),n("span",{staticClass:"line-number"},[s._v("23")]),n("br"),n("span",{staticClass:"line-number"},[s._v("24")]),n("br"),n("span",{staticClass:"line-number"},[s._v("25")]),n("br"),n("span",{staticClass:"line-number"},[s._v("26")]),n("br"),n("span",{staticClass:"line-number"},[s._v("27")]),n("br")])]),n("div",{staticClass:"language-bash line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 范例 2： 限制 pro1 这个群组，每次仅能有一个用户登录系统 maxlogins")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@study ~"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# vim /etc/security/limits.conf")]),s._v("\n@pro1   hard    maxlogins "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 群组功能限制，似乎只对初始群组才有效果限制")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 如果尝试多个 pro1 的登录时，第二个以后就无法登录了")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 并且会在 /var/secure 文件中还会出现如下的信息")]),s._v("\npam_limits"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("login:session"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(": Too many logins "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("max "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("for")]),s._v(" pro1\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br")])]),n("p",[s._v("该文件设置完就生效了。由于 PAM 是在程序调用时才设置，对于已经登录过的系统是没有效果的。再次登录时才会生效")]),s._v(" "),n("h3",{attrs:{id:"var-log-secure、-var-log-messages"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#var-log-secure、-var-log-messages"}},[s._v("#")]),s._v(" "),n("code",[s._v("/var/log/secure、/var/log/messages")])]),s._v(" "),n("p",[s._v("如果发生任何无法登录或则是产生一些你无法预期的错误时，由于 PAM 模块都会将数据记载到 "),n("code",[s._v("/etc/log/secure")]),s._v(" 中，所以发生了问题，务必到该文件查看下日志信息。")]),s._v(" "),n("p",[s._v("举例来说：在 "),n("code",[s._v("limits.conf")]),s._v(" 介绍的范例 2 中，多重登录错误可以到 "),n("code",[s._v("/var/log/secure")]),s._v(" 内查询")])])}),[],!1,null,null,null);a.default=e.exports}}]);