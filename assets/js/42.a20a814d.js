(window.webpackJsonp=window.webpackJsonp||[]).push([[42],{499:function(s,t,a){s.exports=a.p+"assets/img/image-20200322154057573.962b1ea9.png"},657:function(s,t,a){"use strict";a.r(t);var n=a(16),e=Object(n.a)({},(function(){var s=this,t=s.$createElement,n=s._self._c||t;return n("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[n("h1",{attrs:{id:"登录文件的轮替-logrotate"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#登录文件的轮替-logrotate"}},[s._v("#")]),s._v(" 登录文件的轮替 logrotate")]),s._v(" "),n("p",[s._v("轮替，就是定时的执行备份操作，可以查看 "),n("code",[s._v("/etc/cron.daily/logrotate")]),s._v(" ，里面配置了文件轮替行为")]),s._v(" "),n("h2",{attrs:{id:"logrotate-的配置文件"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#logrotate-的配置文件"}},[s._v("#")]),s._v(" logrotate 的配置文件")]),s._v(" "),n("p",[s._v("配置文件如下：")]),s._v(" "),n("ul",[n("li",[n("code",[s._v("/etc/logrotate.conf")]),s._v("：配置文件")]),s._v(" "),n("li",[n("code",[s._v("/etc/logrotate.d/")]),s._v("：该目录下是细化的分类，比如你有你自己的软件需要轮替操作，就可以放到该目录下")])]),s._v(" "),n("p",[s._v("logrotate 的主要功能是将旧的日志文件移动成旧文件，并且重新建立一个新的空的文件。它的执行结果如下图示意：")]),s._v(" "),n("p",[n("img",{attrs:{src:a(499),alt:"image-20200322154057573"}})]),s._v(" "),n("p",[s._v("上图是一个过程，后面的图示已经包含了前面的过程。")]),s._v(" "),n("ul",[n("li",[s._v("第 1 次执行完 rotate 后：原本的 messages 文件变成了 messages.1，而且会制造一个空的 message 出来")]),s._v(" "),n("li",[s._v("第 2 次：messages.1 变成了 messages.2")])]),s._v(" "),n("p",[s._v("以此下去，如果我们设置值保留三个文件日志信息，那么当执行第 4 次的时候，则 messages.3 会被移除，也就是新的备份文件会将旧的给覆盖掉")]),s._v(" "),n("p",[s._v("那么多久执行一次 logrotate 呢？保留几个备份文件呢？这些都在 logrotate.conf 中配置的")]),s._v(" "),n("div",{staticClass:"language-bash line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@study ~"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# vim /etc/logrotate.conf ")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 下面是预设的默认值，如果某些文件又设置了其他的参数，那么就以它自己的设置为准")]),s._v("\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v('# see "man logrotate" for details')]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# rotate log files weekly")]),s._v("\nweekly\t\t\t\t"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 每周进行一次")]),s._v("\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# keep 4 weeks worth of backlogs")]),s._v("\nrotate "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("4")]),s._v("\t\t\t"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 保留几个日志文件，这里预设是 4 个")]),s._v("\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# create new (empty) log files after rotating old ones")]),s._v("\ncreate\t\t\t\t"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 是否建立一个新的文件来继续存储新的数据")]),s._v("\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# use date as a suffix of the rotated file")]),s._v("\ndateext\t\t\t\t"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 是否为轮替的文件加上日期作为文件名")]),s._v("\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# uncomment this if you want your log files compressed")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#compress\t\t\t# 轮替的文件是否需要压缩")]),s._v("\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# RPM packages drop log rotation information into this directory")]),s._v("\ninclude /etc/logrotate.d\t\t"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 该目录中的所有文件都读进来执行 rotate 的工作")]),s._v("\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# no packages own wtmp and btmp -- we'll rotate them here")]),s._v("\n/var/log/wtmp "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\t\t"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 仅针对  /var/log/wtmp 所设置的参数")]),s._v("\n    monthly\t\t\t\t\t\t\t\t\t"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 每个月一次")]),s._v("\n    create 0664 root utmp\t\t"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 创建新文件的权限所属账户/群组")]),s._v("\n    minsize 1M\t\t\t\t\t\t\t"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 文件容量超过 1M 后才进行 rotate")]),s._v("\n    rotate "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("\t\t\t\t\t\t\t\t"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 仅保留一个，即只有 wtmp.1 ")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# wtmp 可记录登陆者与系统重新启动时的实际与来源主机以及登录期间的实际")]),s._v("\n/var/log/btmp "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    missingok\n    monthly\n    create 0600 root utmp\n    rotate "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# system-specific logs may be also be configured here")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br"),n("span",{staticClass:"line-number"},[s._v("22")]),n("br"),n("span",{staticClass:"line-number"},[s._v("23")]),n("br"),n("span",{staticClass:"line-number"},[s._v("24")]),n("br"),n("span",{staticClass:"line-number"},[s._v("25")]),n("br"),n("span",{staticClass:"line-number"},[s._v("26")]),n("br"),n("span",{staticClass:"line-number"},[s._v("27")]),n("br"),n("span",{staticClass:"line-number"},[s._v("28")]),n("br"),n("span",{staticClass:"line-number"},[s._v("29")]),n("br"),n("span",{staticClass:"line-number"},[s._v("30")]),n("br"),n("span",{staticClass:"line-number"},[s._v("31")]),n("br"),n("span",{staticClass:"line-number"},[s._v("32")]),n("br"),n("span",{staticClass:"line-number"},[s._v("33")]),n("br"),n("span",{staticClass:"line-number"},[s._v("34")]),n("br"),n("span",{staticClass:"line-number"},[s._v("35")]),n("br"),n("span",{staticClass:"line-number"},[s._v("36")]),n("br"),n("span",{staticClass:"line-number"},[s._v("37")]),n("br"),n("span",{staticClass:"line-number"},[s._v("38")]),n("br")])]),n("p",[s._v("从配置文件中看到 "),n("code",[s._v("/etc/logrotate.d/")]),s._v(" 目录是该配置文件的规范支持。用途就是方便添加自定义的配置文件，而不用把所有配置都写到主要的配置文件中。比如你开发了一个软件，有轮替日志文件的需求，就可以吧配置文件放到该目录下，就可以了")]),s._v(" "),n("p",[s._v("下面以 "),n("code",[s._v("rsyslog.service")]),s._v(" 服务的文件，来设置它的 rotate")]),s._v(" "),n("div",{staticClass:"language-bash line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 该文件是存在的，我们来修改与学习")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@study ~"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# vim /etc/logrotate.d/syslog ")]),s._v("\n/var/log/cron\n/var/log/maillog\n/var/log/messages\n/var/log/secure\n/var/log/spooler\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    missingok\n    sharedscripts\n    postrotate\n        /bin/kill -HUP "),n("span",{pre:!0,attrs:{class:"token variable"}},[n("span",{pre:!0,attrs:{class:"token variable"}},[s._v("`")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("cat")]),s._v(" /var/run/syslogd.pid "),n("span",{pre:!0,attrs:{class:"token operator"}},[n("span",{pre:!0,attrs:{class:"token file-descriptor important"}},[s._v("2")]),s._v(">")]),s._v(" /dev/null"),n("span",{pre:!0,attrs:{class:"token variable"}},[s._v("`")])]),s._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[n("span",{pre:!0,attrs:{class:"token file-descriptor important"}},[s._v("2")]),s._v(">")]),s._v(" /dev/null "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("||")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("true")]),s._v("\n    endscript\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br")])]),n("p",[s._v("下面来看看设置的语法")]),s._v(" "),n("ul",[n("li",[n("p",[s._v("文件名：可以用空格符号分割多个文件")])]),s._v(" "),n("li",[n("p",[s._v("参数："),n("code",[s._v("{}")]),s._v(" 中的配置")])]),s._v(" "),n("li",[n("p",[s._v("执行脚本：")]),s._v(" "),n("p",[s._v("可以调用外部指令来进行额外的命令，需要与 "),n("code",[s._v("sharedscripts...endscript")]),s._v(" 的设置，可用环境含义：")]),s._v(" "),n("ul",[n("li",[n("p",[s._v("prerotate：在启动 logrotate 之前进行的指令，例如修改日志文件的属性等操作")])]),s._v(" "),n("li",[n("p",[s._v("postrotate：在做完 logrotate 之后启动的指令，例如重新启动（kill -HUP） 某个服务")])])])])]),s._v(" "),n("p",[s._v("​        上面两个钩子在对于已加上特殊属性的文件处理上面，很重要方便")]),s._v(" "),n("p",[s._v("那么上述文件的配置含义为：")]),s._v(" "),n("ul",[n("li",[s._v("该配置只对上述列出来的 5 个文件有效")]),s._v(" "),n("li",[s._v("每周一次、保留 4 个、且轮替下来的文件不进行压缩；这些都是默认值，并没有在该文件中配置")]),s._v(" "),n("li",[s._v("轮替完成后（postrotate）取得 syslog 的 PID 后，以 kill-HUP 方式重新启动 syslogd")])]),s._v(" "),n("p",[s._v("但是如果有特殊属性的话，比如使用了 "),n("code",[s._v("chattr +a")]),s._v("，那么该文件无法删除，也就是无法被更名，而 logrotate 的工作原理就是将当前的文件更名。这个时候就可以使用上面提供的两个钩子方法来解决这个问题")]),s._v(" "),n("div",{staticClass:"language-bash line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@study ~"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# vim /etc/logrotate.d/syslog ")]),s._v("\n/var/log/cron\n/var/log/maillog\n/var/log/messages\n/var/log/secure\n/var/log/spooler\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n\t  sharedscripts\n    prerotate\n    \t/usr/bin/chattr -a /var/log/messages\n    endscript\n    missingok\n    sharedscripts\n    postrotate\n        /bin/kill -HUP "),n("span",{pre:!0,attrs:{class:"token variable"}},[n("span",{pre:!0,attrs:{class:"token variable"}},[s._v("`")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("cat")]),s._v(" /var/run/syslogd.pid "),n("span",{pre:!0,attrs:{class:"token operator"}},[n("span",{pre:!0,attrs:{class:"token file-descriptor important"}},[s._v("2")]),s._v(">")]),s._v(" /dev/null"),n("span",{pre:!0,attrs:{class:"token variable"}},[s._v("`")])]),s._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[n("span",{pre:!0,attrs:{class:"token file-descriptor important"}},[s._v("2")]),s._v(">")]),s._v(" /dev/null "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("||")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("true")]),s._v("\n\t\t\t\t/usr/bin/chattr +a /var/log/messages   \n   endscript\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br")])]),n("p",[s._v("提示下："),n("code",[s._v("kill -HUP")]),s._v(" 指定的信号量含义是将 rsyslog.conf 资料重新读取一次，可以理解为 reload 操作")]),s._v(" "),n("h2",{attrs:{id:"实际测试-logrotate-动作"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#实际测试-logrotate-动作"}},[s._v("#")]),s._v(" 实际测试 logrotate 动作")]),s._v(" "),n("p",[s._v("上述测试完成之后，测试下")]),s._v(" "),n("div",{staticClass:"language-bash line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[n("span",{pre:!0,attrs:{class:"token function"}},[s._v("logrotate")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("-vf"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" logfile\n\n选项与参数：\n\t-v：启动显示模式，会显示 "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("logrotate")]),s._v(" 运行的过程\n\t-f：无论是否符合配置文件的数据，强制每个日志文件都进行 rotate 的操作\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br")])]),n("p",[s._v("下面执行一次看看整个流程")]),s._v(" "),n("div",{staticClass:"language-bash line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@study ~"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# logrotate -v /etc/logrotate.conf ")]),s._v("\nreading config "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("file")]),s._v(" /etc/logrotate.conf\t\t"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 读取主要的配置文件")]),s._v("\nincluding /etc/logrotate.d\t\t\t\t\t\t\t\t"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 读取模块化的外部配置文件")]),s._v("\nreading config "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("file")]),s._v(" bootlog\nreading config "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("file")]),s._v(" chrony\nreading config "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("file")]),s._v(" cups\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v("\nAllocating "),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("hash")]),s._v(" table "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("for")]),s._v(" state file, size "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("15360")]),s._v(" B\n\nHandling "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("15")]),s._v(" logs\t\t\t\t\t\t\t"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 共有 15 个日志文件")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v(".\nrotating pattern: /var/log/cron\n/var/log/maillog\n/var/log/messages\n/var/log/secure\n/var/log/spooler\n weekly "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("4")]),s._v(" rotations"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\nempty log files are rotated, old logs are removed\nconsidering log /var/log/cron\n  log does not need rotating "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("log has been rotated at "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("2020")]),s._v("-3-15 "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("21")]),s._v(":37, that is not week ago yet"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\nconsidering log /var/log/maillog\n  log does not need rotating "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("log has been rotated at "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("2020")]),s._v("-3-15 "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("21")]),s._v(":37, that is not week ago yet"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\nconsidering log /var/log/messages\t\t"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 处理 messages 文件")]),s._v("\n\t"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 由于时间未到，不需要操作")]),s._v("\n  log does not need rotating "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("log has been rotated at "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("2020")]),s._v("-3-15 "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("21")]),s._v(":37, that is not week ago yet"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\nconsidering log /var/log/secure\n  log does not need rotating "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("log has been rotated at "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("2020")]),s._v("-3-15 "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("21")]),s._v(":37, that is not week ago yet"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\nconsidering log /var/log/spooler\n  log does not need rotating "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("log has been rotated at "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("2020")]),s._v("-3-15 "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("21")]),s._v(":37, that is not week ago yet"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\nnot running postrotate script, since no logs were rotated\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br"),n("span",{staticClass:"line-number"},[s._v("22")]),n("br"),n("span",{staticClass:"line-number"},[s._v("23")]),n("br"),n("span",{staticClass:"line-number"},[s._v("24")]),n("br"),n("span",{staticClass:"line-number"},[s._v("25")]),n("br"),n("span",{staticClass:"line-number"},[s._v("26")]),n("br"),n("span",{staticClass:"line-number"},[s._v("27")]),n("br"),n("span",{staticClass:"line-number"},[s._v("28")]),n("br"),n("span",{staticClass:"line-number"},[s._v("29")]),n("br"),n("span",{staticClass:"line-number"},[s._v("30")]),n("br")])]),n("div",{staticClass:"language-bash line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 范例 2：强制 logrotate 操作")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@study ~"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# logrotate -v /etc/logrotate.conf ")]),s._v("\nrotating pattern: /var/log/cron\n/var/log/maillog\n/var/log/messages\n/var/log/secure\n/var/log/spooler\n forced from "),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("command")]),s._v(" line "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("4")]),s._v(" rotations"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\nempty log files are rotated, old logs are removed\nconsidering log /var/log/cron\n  log needs rotating\nconsidering log /var/log/maillog\n  log needs rotating\nconsidering log /var/log/messages\n  log needs rotating\nconsidering log /var/log/secure\n  log needs rotating\nconsidering log /var/log/spooler\n  log needs rotating\nrotating log /var/log/cron, log-"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("rotateCount is "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("4")]),s._v("\ndateext suffix "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'-20200316'")]),s._v("\nglob pattern "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'-[0-9][0-9][0-9][0-9][0-9][0-9][0-9][0-9]'")]),s._v("\nrotating log /var/log/maillog, log-"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("rotateCount is "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("4")]),s._v("\ndateext suffix "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'-20200316'")]),s._v("\nglob pattern "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'-[0-9][0-9][0-9][0-9][0-9][0-9][0-9][0-9]'")]),s._v("\nrotating log /var/log/messages, log-"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("rotateCount is "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("4")]),s._v("\ndateext suffix "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'-20200316'")]),s._v("\nglob pattern "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'-[0-9][0-9][0-9][0-9][0-9][0-9][0-9][0-9]'")]),s._v("\nrotating log /var/log/secure, log-"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("rotateCount is "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("4")]),s._v("\nglob pattern "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'-[0-9][0-9][0-9][0-9][0-9][0-9][0-9][0-9]'")]),s._v("\nfscreate context "),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("set")]),s._v(" to system_u:object_r:cron_log_t:s0\nrenaming /var/log/cron to /var/log/cron-20200316\ncreating new /var/log/cron mode "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" 0600 uid "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" gid "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("\nfscreate context "),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("set")]),s._v(" to system_u:object_r:var_log_t:s0\nrenaming /var/log/maillog to /var/log/maillog-20200316\ncreating new /var/log/maillog mode "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" 0600 uid "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" gid "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("\nfscreate context "),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("set")]),s._v(" to system_u:object_r:var_log_t:s0\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 重命名了文件，然后又创建了一个文件")]),s._v("\nrenaming /var/log/messages to /var/log/messages-20200316\ncreating new /var/log/messages mode "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" 0600 uid "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" gid "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("\nfscreate context "),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("set")]),s._v(" to system_u:object_r:var_log_t:s0\nrenaming /var/log/secure to /var/log/secure-20200316\ncreating new /var/log/secure mode "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" 0600 uid "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" gid "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("\nfscreate context "),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("set")]),s._v(" to system_u:object_r:var_log_t:s0\nrenaming /var/log/spooler to /var/log/spooler-20200316\ncreating new /var/log/spooler mode "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" 0600 uid "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" gid "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("\nrunning postrotate script\nremoving old log /var/log/cron-20200225\nremoving old log /var/log/maillog-20200225\nremoving old log /var/log/messages-20200225\nremoving old log /var/log/secure-20200225\nremoving old log /var/log/spooler-20200225\n\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@study ~"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# ll /var/log/messages*; lsattr /var/log/messages")]),s._v("\n-rw-------. "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" root root    "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("345")]),s._v(" Mar "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("16")]),s._v(" 00:01 /var/log/messages\n-rw-------. "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" root root "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("756608")]),s._v(" Mar  "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("18")]),s._v(":30 /var/log/messages-20200301\n-rw-------. "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" root root "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("270175")]),s._v(" Mar  "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("8")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("12")]),s._v(":23 /var/log/messages-20200308\n-rw-------. "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" root root "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("187277")]),s._v(" Mar "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("15")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("21")]),s._v(":30 /var/log/messages-20200315\n-rw-------. "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" root root  "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("12425")]),s._v(" Mar "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("16")]),s._v(" 00:00 /var/log/messages-20200316\n-----a---------- /var/log/messages\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 上面我们配置的处理特殊属性的脚本生效了")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br"),n("span",{staticClass:"line-number"},[s._v("22")]),n("br"),n("span",{staticClass:"line-number"},[s._v("23")]),n("br"),n("span",{staticClass:"line-number"},[s._v("24")]),n("br"),n("span",{staticClass:"line-number"},[s._v("25")]),n("br"),n("span",{staticClass:"line-number"},[s._v("26")]),n("br"),n("span",{staticClass:"line-number"},[s._v("27")]),n("br"),n("span",{staticClass:"line-number"},[s._v("28")]),n("br"),n("span",{staticClass:"line-number"},[s._v("29")]),n("br"),n("span",{staticClass:"line-number"},[s._v("30")]),n("br"),n("span",{staticClass:"line-number"},[s._v("31")]),n("br"),n("span",{staticClass:"line-number"},[s._v("32")]),n("br"),n("span",{staticClass:"line-number"},[s._v("33")]),n("br"),n("span",{staticClass:"line-number"},[s._v("34")]),n("br"),n("span",{staticClass:"line-number"},[s._v("35")]),n("br"),n("span",{staticClass:"line-number"},[s._v("36")]),n("br"),n("span",{staticClass:"line-number"},[s._v("37")]),n("br"),n("span",{staticClass:"line-number"},[s._v("38")]),n("br"),n("span",{staticClass:"line-number"},[s._v("39")]),n("br"),n("span",{staticClass:"line-number"},[s._v("40")]),n("br"),n("span",{staticClass:"line-number"},[s._v("41")]),n("br"),n("span",{staticClass:"line-number"},[s._v("42")]),n("br"),n("span",{staticClass:"line-number"},[s._v("43")]),n("br"),n("span",{staticClass:"line-number"},[s._v("44")]),n("br"),n("span",{staticClass:"line-number"},[s._v("45")]),n("br"),n("span",{staticClass:"line-number"},[s._v("46")]),n("br"),n("span",{staticClass:"line-number"},[s._v("47")]),n("br"),n("span",{staticClass:"line-number"},[s._v("48")]),n("br"),n("span",{staticClass:"line-number"},[s._v("49")]),n("br"),n("span",{staticClass:"line-number"},[s._v("50")]),n("br"),n("span",{staticClass:"line-number"},[s._v("51")]),n("br"),n("span",{staticClass:"line-number"},[s._v("52")]),n("br"),n("span",{staticClass:"line-number"},[s._v("53")]),n("br"),n("span",{staticClass:"line-number"},[s._v("54")]),n("br"),n("span",{staticClass:"line-number"},[s._v("55")]),n("br"),n("span",{staticClass:"line-number"},[s._v("56")]),n("br"),n("span",{staticClass:"line-number"},[s._v("57")]),n("br"),n("span",{staticClass:"line-number"},[s._v("58")]),n("br"),n("span",{staticClass:"line-number"},[s._v("59")]),n("br"),n("span",{staticClass:"line-number"},[s._v("60")]),n("br"),n("span",{staticClass:"line-number"},[s._v("61")]),n("br")])]),n("p",[s._v("由于 logrotate 已经加入到 crontab 里面了，只需要留意下 "),n("code",[s._v("/var/log/messages")]),s._v(" 是否有类似如下的信息")]),s._v(" "),n("div",{staticClass:"language-bash line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@study ~"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# grep 'www.rsyslog.com' /var/log/messages")]),s._v("\nMar "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("16")]),s._v(" 00:00:42 study rsyslogd: "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("origin "),n("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("software")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"rsyslogd"')]),s._v(" "),n("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("swVersion")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"8.24.0-38.el7"')]),s._v(" x-pid"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"7107"')]),s._v(" x-info"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"http://www.rsyslog.com"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" rsyslogd was HUPed\n\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br")])]),n("p",[s._v("这个是 rsyslogd 重新启动的时间，（因为 "),n("code",[s._v("/etc/logrotate.d/syslog")]),s._v(" 中配置了重新启动的）")]),s._v(" "),n("h2",{attrs:{id:"自定义日志文件的轮替功能"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#自定义日志文件的轮替功能"}},[s._v("#")]),s._v(" 自定义日志文件的轮替功能")]),s._v(" "),n("p",[s._v("在前面章节总， 建立了一个 "),n("code",[s._v("/var/log/admin.log")]),s._v(" 文件，需要配置如下需求")]),s._v(" "),n("ul",[n("li",[s._v("添加 "),n("code",[s._v("+a")]),s._v(" 属性")]),s._v(" "),n("li",[s._v("一个月轮替一次")]),s._v(" "),n("li",[s._v("当文件大于 10MB 时，则主动轮替，不需要考虑一个月的时间")]),s._v(" "),n("li",[s._v("保存 5 个备份文件")]),s._v(" "),n("li",[s._v("备份文件需要压缩")])]),s._v(" "),n("div",{staticClass:"language-bash line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 1. 添加 a 属性，并测试是否有效")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@study ~"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# chattr +a /var/log/admin.log")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@study ~"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# lsattr /var/log/admin.log")]),s._v("\n-----a---------- /var/log/admin.log\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@study ~"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# rm /var/log/admin.log ")]),s._v("\nrm: remove regular "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("file")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'/var/log/admin.log'")]),s._v("? y\nrm: cannot remove "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'/var/log/admin.log'")]),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" Operation not permitted\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 连 root 都无法删除")]),s._v("\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 2. 建立 logrotate 配置文件")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@study ~"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# vim /etc/logrotate.d/admin")]),s._v("\n/var/log/admin.log "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  monthly\t\t"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 每个月一次")]),s._v("\n  "),n("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("size")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("10M\t"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 文件容量大于 10M 则开始处置")]),s._v("\n  rotate "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("5")]),s._v("\t"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 保留 5 个")]),s._v("\n  compress\t"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 压缩")]),s._v("\n  sharedscripts\n  prerotate\n        /usr/bin/chattr -a /var/log/admin.log\n  endscript\n  sharedscripts\n  postrotate\n  \t\t\t"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 就是这里，每个都要重新启动啊？难该服务启动得有点频繁啊")]),s._v("\n        /bin/kill -HUP "),n("span",{pre:!0,attrs:{class:"token variable"}},[n("span",{pre:!0,attrs:{class:"token variable"}},[s._v("`")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("cat")]),s._v(" /var/run/syslogd.pid "),n("span",{pre:!0,attrs:{class:"token operator"}},[n("span",{pre:!0,attrs:{class:"token file-descriptor important"}},[s._v("2")]),s._v(">")]),s._v(" /dev/null"),n("span",{pre:!0,attrs:{class:"token variable"}},[s._v("`")])]),s._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[n("span",{pre:!0,attrs:{class:"token file-descriptor important"}},[s._v("2")]),s._v(">")]),s._v(" /dev/null "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("||")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("true")]),s._v("\n        /usr/bin/chattr +a /var/log/admin.log\n  endscript\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 3. 测试下 logrotate 相关功能信息显示")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@study ~"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# logrotate -v /etc/logrotate.conf ")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@study ~"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# logrotate -v /etc/logrotate.conf             ")]),s._v("\nreading config "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("file")]),s._v(" /etc/logrotate.conf\nincluding /etc/logrotate.d\nreading config "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("file")]),s._v(" admin\t\t"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 看到已经加载我们的配置文件了")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v(".\nrotating pattern: /var/log/admin.log  "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("10485760")]),s._v(" bytes "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("5")]),s._v(" rotations"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\nempty log files are rotated, old logs are removed\nconsidering log /var/log/admin.log\n  log does not need rotating "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("log size is below the "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'size'")]),s._v(" threshold"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\nnot running prerotate script, since no logs will be rotated\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 可以看到，检测到 size 不够，不用处理")]),s._v("\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 4. 强制执行 logrotate ，并查看相关信息")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@study ~"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# logrotate -vf /etc/logrotate.conf")]),s._v("\nrotating pattern: /var/log/admin.log  forced from "),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("command")]),s._v(" line "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("5")]),s._v(" rotations"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\nempty log files are rotated, old logs are removed\nconsidering log /var/log/admin.log\n  log needs rotating\nrotating log /var/log/admin.log, log-"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("rotateCount is "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("5")]),s._v("\ndateext suffix "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'-20200316'")]),s._v("\nglob pattern "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'-[0-9][0-9][0-9][0-9][0-9][0-9][0-9][0-9]'")]),s._v("\nglob finding old rotated logs failed\nrunning prerotate script\nfscreate context "),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("set")]),s._v(" to system_u:object_r:var_log_t:s0\nrenaming /var/log/admin.log to /var/log/admin.log-20200316\ncreating new /var/log/admin.log mode "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" 0600 uid "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" gid "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("\nrunning postrotate script\ncompressing log with: /bin/gzip\n"),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("set")]),s._v(" default create context to system_u:object_r:var_log_t:s0\n\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@study ~"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# lsattr /var/log/admin.log*       ")]),s._v("\n-----a---------- /var/log/admin.log\n---------------- /var/log/admin.log-20200316.gz\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 可以看到的确被压缩过，当前的 a 属性也正常")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br"),n("span",{staticClass:"line-number"},[s._v("22")]),n("br"),n("span",{staticClass:"line-number"},[s._v("23")]),n("br"),n("span",{staticClass:"line-number"},[s._v("24")]),n("br"),n("span",{staticClass:"line-number"},[s._v("25")]),n("br"),n("span",{staticClass:"line-number"},[s._v("26")]),n("br"),n("span",{staticClass:"line-number"},[s._v("27")]),n("br"),n("span",{staticClass:"line-number"},[s._v("28")]),n("br"),n("span",{staticClass:"line-number"},[s._v("29")]),n("br"),n("span",{staticClass:"line-number"},[s._v("30")]),n("br"),n("span",{staticClass:"line-number"},[s._v("31")]),n("br"),n("span",{staticClass:"line-number"},[s._v("32")]),n("br"),n("span",{staticClass:"line-number"},[s._v("33")]),n("br"),n("span",{staticClass:"line-number"},[s._v("34")]),n("br"),n("span",{staticClass:"line-number"},[s._v("35")]),n("br"),n("span",{staticClass:"line-number"},[s._v("36")]),n("br"),n("span",{staticClass:"line-number"},[s._v("37")]),n("br"),n("span",{staticClass:"line-number"},[s._v("38")]),n("br"),n("span",{staticClass:"line-number"},[s._v("39")]),n("br"),n("span",{staticClass:"line-number"},[s._v("40")]),n("br"),n("span",{staticClass:"line-number"},[s._v("41")]),n("br"),n("span",{staticClass:"line-number"},[s._v("42")]),n("br"),n("span",{staticClass:"line-number"},[s._v("43")]),n("br"),n("span",{staticClass:"line-number"},[s._v("44")]),n("br"),n("span",{staticClass:"line-number"},[s._v("45")]),n("br"),n("span",{staticClass:"line-number"},[s._v("46")]),n("br"),n("span",{staticClass:"line-number"},[s._v("47")]),n("br"),n("span",{staticClass:"line-number"},[s._v("48")]),n("br"),n("span",{staticClass:"line-number"},[s._v("49")]),n("br"),n("span",{staticClass:"line-number"},[s._v("50")]),n("br"),n("span",{staticClass:"line-number"},[s._v("51")]),n("br"),n("span",{staticClass:"line-number"},[s._v("52")]),n("br"),n("span",{staticClass:"line-number"},[s._v("53")]),n("br"),n("span",{staticClass:"line-number"},[s._v("54")]),n("br"),n("span",{staticClass:"line-number"},[s._v("55")]),n("br"),n("span",{staticClass:"line-number"},[s._v("56")]),n("br"),n("span",{staticClass:"line-number"},[s._v("57")]),n("br"),n("span",{staticClass:"line-number"},[s._v("58")]),n("br"),n("span",{staticClass:"line-number"},[s._v("59")]),n("br"),n("span",{staticClass:"line-number"},[s._v("60")]),n("br"),n("span",{staticClass:"line-number"},[s._v("61")]),n("br"),n("span",{staticClass:"line-number"},[s._v("62")]),n("br"),n("span",{staticClass:"line-number"},[s._v("63")]),n("br"),n("span",{staticClass:"line-number"},[s._v("64")]),n("br")])])])}),[],!1,null,null,null);t.default=e.exports}}]);