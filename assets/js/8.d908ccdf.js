(window.webpackJsonp=window.webpackJsonp||[]).push([[8],{503:function(s,t,a){s.exports=a.p+"assets/img/image-20200331214428334.c6756db0.png"},504:function(s,t,a){s.exports=a.p+"assets/img/image-20200331214650243.238d5a62.png"},505:function(s,t,a){s.exports=a.p+"assets/img/image-20200331215159375.b2f4118b.png"},506:function(s,t,a){s.exports=a.p+"assets/img/image-20200331215301052.27ccfb91.png"},507:function(s,t,a){s.exports=a.p+"assets/img/image-20200331220333935.474711ae.png"},665:function(s,t,a){"use strict";a.r(t);var n=a(16),e=Object(n.a)({},(function(){var s=this,t=s.$createElement,n=s._self._c||t;return n("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[n("h1",{attrs:{id:"boot-loader：grub2"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#boot-loader：grub2"}},[s._v("#")]),s._v(" Boot Loader：Grub2")]),s._v(" "),n("p",[s._v("前面知识点来看，boot loader 是载入核心的重要工具，来讲下 Linux 中最流行的 grub2 这个 boot loader")]),s._v(" "),n("h2",{attrs:{id:"boot-loader-的两个-stage"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#boot-loader-的两个-stage"}},[s._v("#")]),s._v(" boot loader 的两个 stage")]),s._v(" "),n("p",[s._v("曾经讲到，在 BIOS 读完信息后，接下来会到第一个开机设备的 MBR 去读取 boot loader 。该 boot loader 可以具有选单功能、字节加载核心文件以及控制权移交功能等，系统必须要有 loader 才能够加载该操作系统的核心。")]),s._v(" "),n("p",[s._v("但是 MBR 是整个硬盘的第一个 sector 内的一个区块，整个大小才 446 bytes 。即使 GPT 也没有很大的扇区来存储 loader 数据，那么功能强悍的 loader 是怎么放进去的？")]),s._v(" "),n("p",[s._v("为了解决这个问题，Linux 将 boot loader 的程序代码执行与设置值加载分成两个阶段（stage）执行")]),s._v(" "),n("ul",[n("li",[n("p",[s._v("Stage 1：执行 boot loader 主程序")]),s._v(" "),n("p",[s._v("第一阶段执行 boot loader 的主程序，该主程序必须被安装在开机区，即 MBR 或则是 boot sector，但是因为 MBR 是在太小了，所以通常仅安装 boot loader 的最小主程序，并没有安装 loader 的相关配置文件")])]),s._v(" "),n("li",[n("p",[s._v("Stage 2：主程序加载配置文件")]),s._v(" "),n("p",[s._v("第二阶段通过 boot loader 加载所有配置文件与相关的环境参数文件，包括文件系统定义与主要配置文件 grub.cfg，一般来说，配置文件都在 /boot 下")])])]),s._v(" "),n("p",[s._v("与 grub2 相关的都放在 "),n("code",[s._v("/boot/grub2")])]),s._v(" "),n("div",{staticClass:"language-bash line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@study ~"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# ls -l /boot/grub2")]),s._v("\ntotal "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("32")]),s._v("\n-rw-r--r--. "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" root root   "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("84")]),s._v(" Oct  "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("4")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("18")]),s._v(":31 device.map\t\t\t"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# grub2 的设备对于文件")]),s._v("\ndrwxr-xr-x. "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v(" root root   "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("25")]),s._v(" Oct  "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("4")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("18")]),s._v(":31 fonts\t\t\t\t\t\t"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 开机过程中的画面会使用到的字体数据")]),s._v("\n-rw-r--r--. "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" root root "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("4309")]),s._v(" Oct  "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("4")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("18")]),s._v(":32 grub.cfg\t\t\t\t"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# grub2 的主配置文件，非常重要")]),s._v("\n-rw-r--r--. "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" root root "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("1024")]),s._v(" Oct  "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("4")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("18")]),s._v(":32 grubenv\t\t\t\t\t"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 一些环境区块的符号")]),s._v("\ndrwxr-xr-x. "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v(" root root "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("8192")]),s._v(" Oct  "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("4")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("18")]),s._v(":31 i386-pc\t\t\t\t\t"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 针对一般 x86 PC 所需要的 grub2 的相关模块")]),s._v("\ndrwxr-xr-x. "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v(" root root "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("4096")]),s._v(" Oct  "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("4")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("18")]),s._v(":31 locale\t\t\t\t\t"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 语系相关数据")]),s._v("\n\n\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@study ~"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# ls -l /boot/grub2/i386-pc/")]),s._v("\nacpi.mod\t\t\t\t"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 电源管理有关的模块")]),s._v("\nata.mod\t\t\t\t\t"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 磁盘有关的模块")]),s._v("\nchain.mod·\t\t\t"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 进行 loader 控制全移交的相关模块")]),s._v("\ncommand.lst \t\t"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 一些指令相关性的列表")]),s._v("\nefiemu32.o\t\t\t"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 与 uefi BIOS 先关的模块")]),s._v("\nefiemu64.o\nefiemu.mod\next2.mod\t\t\t\t"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# EXT w文件系统家族相关模块")]),s._v("\nfat.mod\t\t\t\t\t"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# FAT 文件系统模块")]),s._v("\ngcry_sha256.mod\t"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 常见的加密模块")]),s._v("\niso9660.mod\t\t\t"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 光盘文件系统模块")]),s._v("\nlvm.mod \t\t\t\t"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# LVM 文件系统模块")]),s._v("\nmdraid09.mod\t\t"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 软件磁盘阵列模块")]),s._v("\nminix.mod\t\t\t\t"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# MINIX 相关文件系统模块")]),s._v("\nmsdospart.mod\t\t"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 一般 MBR 分区表")]),s._v("\npart_gpt.mod    "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# GPT 分区表")]),s._v("\npart_msdos.mod\t"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# MBR 分区表")]),s._v("\nscsi.mod\t\t\t\t"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# SCSI 相关模块")]),s._v("\nusb_keyboard.mod\t"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# usb 模相关模块")]),s._v("\nusb.mod\nvga.mod\t\t\t\t\t"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# VGA 显卡相关模块")]),s._v("\nxfs.mod\t\t\t\t\t"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# XFS 文件系统模块")]),s._v("\n。。。。 等等很多模块\n\n\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br"),n("span",{staticClass:"line-number"},[s._v("22")]),n("br"),n("span",{staticClass:"line-number"},[s._v("23")]),n("br"),n("span",{staticClass:"line-number"},[s._v("24")]),n("br"),n("span",{staticClass:"line-number"},[s._v("25")]),n("br"),n("span",{staticClass:"line-number"},[s._v("26")]),n("br"),n("span",{staticClass:"line-number"},[s._v("27")]),n("br"),n("span",{staticClass:"line-number"},[s._v("28")]),n("br"),n("span",{staticClass:"line-number"},[s._v("29")]),n("br"),n("span",{staticClass:"line-number"},[s._v("30")]),n("br"),n("span",{staticClass:"line-number"},[s._v("31")]),n("br"),n("span",{staticClass:"line-number"},[s._v("32")]),n("br"),n("span",{staticClass:"line-number"},[s._v("33")]),n("br"),n("span",{staticClass:"line-number"},[s._v("34")]),n("br"),n("span",{staticClass:"line-number"},[s._v("35")]),n("br"),n("span",{staticClass:"line-number"},[s._v("36")]),n("br")])]),n("p",[n("code",[s._v("/boot/grub2")]),s._v(" 目录下最重要的是 grub2.cfg 配置文件，以及各种文件系统的定义。所以 loader 读取了这种文件系统定义数据后，就能够认识文件系统并读取在该文件系统内的核心文件了")]),s._v(" "),n("p",[s._v("从上面的文件来看， grub2 认识的文件系统与磁盘分区格式真的非常多，正因为如此，grub2 才会取代 Lio/grub 这个老婆的 boot loader")]),s._v(" "),n("h2",{attrs:{id:"grub2-的配置文件-boot-grub2-grub-cfg-初探"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#grub2-的配置文件-boot-grub2-grub-cfg-初探"}},[s._v("#")]),s._v(" grub2 的配置文件 "),n("code",[s._v("/boot/grub2/grub.cfg")]),s._v(" 初探")]),s._v(" "),n("p",[s._v("Grub2 的有点挺多，包括：")]),s._v(" "),n("ul",[n("li",[n("p",[s._v("认识与支持较多的文件系统，并且可以使用 grub2 的主程序直接在文件系统中搜索核心文件")])]),s._v(" "),n("li",[n("p",[s._v("开机时，可以自行编辑与修改改机设置项目，类似 bash 的指令模式")])]),s._v(" "),n("li",[n("p",[s._v("可以动态搜索配置文件，而不需要再修改配置文件后重新安装 grub2。")]),s._v(" "),n("p",[s._v("即修改完配置文件后，下次开机就生效了")])])]),s._v(" "),n("p",[s._v("上面三个优点，也是 Stage 1、Stage 2 分别安装在 MBR（主程序）与文件系统中（配置文件与定义文件）的原因")]),s._v(" "),n("h3",{attrs:{id:"磁盘与分区槽在-grub2-中的代号"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#磁盘与分区槽在-grub2-中的代号"}},[s._v("#")]),s._v(" 磁盘与分区槽在 grub2 中的代号")]),s._v(" "),n("p",[s._v("安装在 MBR 的 grub2 的主程序，中重要任务之一是从磁盘中加载核心文件，让核心能顺利驱动整个系统的硬件")]),s._v(" "),n("p",[s._v("grub2 对硬盘的代号设置与传统的 LInux 磁盘代号完全不同，如下所示")]),s._v(" "),n("div",{staticClass:"language-bash line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("hd0,1"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\t\t\t\t"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 一般的默认语法，由 grub2 自动判断分区格式")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("hd0,msdos1"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\t"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 此磁盘的分区为传统的 MBR 模式")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("hd0,gpt1"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\t\t"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 此磁盘的分区为 GPT 模式")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br")])]),n("p",[s._v("从上面看，与 "),n("code",[s._v("/dev/sda1")]),s._v(" 不相关，只要注意下面几个知识点：")]),s._v(" "),n("ul",[n("li",[s._v("硬盘代号以小括号 "),n("code",[s._v("()")]),s._v(" 包起来")]),s._v(" "),n("li",[s._v("硬盘以 hd 表示，后面会接一组数字")]),s._v(" "),n("li",[s._v("以搜索顺序作为硬盘的编号（这个很重要）")]),s._v(" "),n("li",[s._v("第一个搜索到的硬盘为 0，一次类推")]),s._v(" "),n("li",[s._v("每块磁盘的第一个 partition 代号为 1，依序类推")])]),s._v(" "),n("p",[s._v("如行 "),n("code",[s._v("(hd0,1)")]),s._v(" 表示第一块硬盘，第一个分区槽；始终记得，硬盘号最小为 0，分区槽最小为 1")]),s._v(" "),n("p",[s._v("所以整个硬盘代号为：")]),s._v(" "),n("table",[n("thead",[n("tr",[n("th",[s._v("硬盘搜索顺序")]),s._v(" "),n("th",[s._v("grub2 的代号")])])]),s._v(" "),n("tbody",[n("tr",[n("td",[s._v("第一块磁盘 MBR")]),s._v(" "),n("td",[s._v("(hd0)、(hd0,msdos1)(hd0,msdos2)...")])]),s._v(" "),n("tr",[n("td",[s._v("第二块 GPT")]),s._v(" "),n("td",[s._v("(hd1)、(hd1,gpt1)...")])]),s._v(" "),n("tr",[n("td",[s._v("第三块")]),s._v(" "),n("td",[s._v("(hd2)、(hd2,1)...")])])])]),s._v(" "),n("p",[s._v("例题：你的系统有一块 SATA 硬盘，请说明该硬盘的第一个逻辑分区槽在 Linux 与 grub2 中的文件名与代号")]),s._v(" "),n("p",[s._v("答：STAT 磁盘，使用逻辑分区槽，因此是 "),n("code",[s._v("/dev/sda5")]),s._v(" （1-4 保留给 primary 与 extended 使用）。在 grub2 中则是，由于只有一块磁盘，那么 "),n("code",[s._v("(hd0,msdos5)")]),s._v("，简易写法 "),n("code",[s._v("(hd0,5)")])]),s._v(" "),n("h3",{attrs:{id:"boot-grub2-grub-cfg-配置文件（重点了解，不要随意修改）！"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#boot-grub2-grub-cfg-配置文件（重点了解，不要随意修改）！"}},[s._v("#")]),s._v(" "),n("code",[s._v("/boot/grub2/grub.cfg")]),s._v(" 配置文件（重点了解，不要随意修改）！")]),s._v(" "),n("div",{staticClass:"language-bash line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@study ~"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# vim /boot/grub2/grub.cfg ")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 开始是 00_header 这个脚本执行的结果展示，主要与基础设置与关机有关")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("### BEGIN /etc/grub.d/00_header ###")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("set")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("pager")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("\n\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v(" -s "),n("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$prefix")]),s._v("/grubenv "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("then")]),s._v("\n  load_env\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("fi")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v(".\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v(" x"),n("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$feature_timeout_style")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" xy "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("then")]),s._v("\n  "),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("set")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("timeout_style")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("menu\n  "),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("set")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("timeout")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("5")]),s._v("\t\t\t"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 菜单显示时间")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# Fallback normal timeout code in case the timeout_style feature is")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# unavailable.")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("else")]),s._v("\n  "),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("set")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("timeout")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("5")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("fi")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("### END /etc/grub.d/00_header ###")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v(".\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 开始执行 10_linux ，主要针对实际的 Linux 核心文件的开机环境")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# menuentry：表示选单内容，这里有两个，也就是说开机的时候，出现两个选单")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("### BEGIN /etc/grub.d/10_linux ###")]),s._v("\nmenuentry "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'CentOS Linux (3.10.0-1062.el7.x86_64) 7 (Core)'")]),s._v(" --class centos --class gnu-linux --class gnu --class os --unrestricted "),n("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$menuentry_id_option")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'gnulinux-3.10.0-1062.el7.x86_64-advanced-7b220a88-4e13-4869-9aa9-87031303f3e1'")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        load_video\n        "),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("set")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("gfxpayload")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("keep\n        insmod gzio\n        insmod part_gpt\n        insmod xfs\n        "),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("set")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("root")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'hd0,gpt2'")]),s._v("\t\t\n        "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v(" x"),n("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$feature_platform_search_hint")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" xy "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("then")]),s._v("\n          search --no-floppy --fs-uuid --set"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("root --hint-bios"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("hd1,gpt2 --hint-efi"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("hd1,gpt2 --hint-baremetal"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("ahci1,gpt2 --hint"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'hd0,gpt2'")]),s._v("  13d0663f-4cbd-412d-aa9f-975eb18da590\n        "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("else")]),s._v("\n          search --no-floppy --fs-uuid --set"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("root 13d0663f-4cbd-412d-aa9f-975eb18da590\n        "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("fi")]),s._v("\n        linux16 /vmlinuz-3.10.0-1062.el7.x86_64 "),n("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("root")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("/dev/mapper/centos-root ro "),n("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("crashkernel")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("auto "),n("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("spectre_v2")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("retpoline rd.lvm.lv"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("centos/root rd.lvm.lv"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("centos/swap rhgb quiet "),n("span",{pre:!0,attrs:{class:"token assign-left variable"}},[n("span",{pre:!0,attrs:{class:"token environment constant"}},[s._v("LANG")])]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("zh_CN.UTF-8\n        initrd16 /initramfs-3.10.0-1062.el7.x86_64.img\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\nmenuentry "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'CentOS Linux (0-rescue-f228ab37c368416c84c6b27971ba45a9) 7 (Core)'")]),s._v(" --class centos --class gnu-linux --class gnu --class os --unrestricted "),n("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$menuentry_id_option")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'gnulinux-0-rescue-f228ab37c368416c84c6b27971ba45a9-advanced-7b220a88-4e13-4869-9aa9-87031303f3e1'")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        load_video\n        insmod gzio\n        insmod part_gpt\n        insmod xfs\n        "),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("set")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("root")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'hd0,gpt2'")]),s._v("\n        "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v(" x"),n("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$feature_platform_search_hint")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" xy "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("then")]),s._v("\n          search --no-floppy --fs-uuid --set"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("root --hint-bios"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("hd1,gpt2 --hint-efi"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("hd1,gpt2 --hint-baremetal"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("ahci1,gpt2 --hint"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'hd0,gpt2'")]),s._v("  13d0663f-4cbd-412d-aa9f-975eb18da590\n        "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("else")]),s._v("\n          search --no-floppy --fs-uuid --set"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("root 13d0663f-4cbd-412d-aa9f-975eb18da590\n        "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("fi")]),s._v("\n        linux16 /vmlinuz-0-rescue-f228ab37c368416c84c6b27971ba45a9 "),n("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("root")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("/dev/mapper/centos-root ro "),n("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("crashkernel")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("auto "),n("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("spectre_v2")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("retpoline rd.lvm.lv"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("centos/root rd.lvm.lv"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("centos/swap rhgb quiet\n        initrd16 /initramfs-0-rescue-f228ab37c368416c84c6b27971ba45a9.img\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("### END /etc/grub.d/10_linux ###")]),s._v("\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("### BEGIN /etc/grub.d/20_linux_xen ###")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("### END /etc/grub.d/20_linux_xen ###")]),s._v("\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("### BEGIN /etc/grub.d/20_ppc_terminfo ###")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("### END /etc/grub.d/20_ppc_terminfo ###")]),s._v("\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("### BEGIN /etc/grub.d/30_os-prober ###")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("### END /etc/grub.d/30_os-prober ###")]),s._v("\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("### BEGIN /etc/grub.d/40_custom ###")]),s._v("\n\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br"),n("span",{staticClass:"line-number"},[s._v("22")]),n("br"),n("span",{staticClass:"line-number"},[s._v("23")]),n("br"),n("span",{staticClass:"line-number"},[s._v("24")]),n("br"),n("span",{staticClass:"line-number"},[s._v("25")]),n("br"),n("span",{staticClass:"line-number"},[s._v("26")]),n("br"),n("span",{staticClass:"line-number"},[s._v("27")]),n("br"),n("span",{staticClass:"line-number"},[s._v("28")]),n("br"),n("span",{staticClass:"line-number"},[s._v("29")]),n("br"),n("span",{staticClass:"line-number"},[s._v("30")]),n("br"),n("span",{staticClass:"line-number"},[s._v("31")]),n("br"),n("span",{staticClass:"line-number"},[s._v("32")]),n("br"),n("span",{staticClass:"line-number"},[s._v("33")]),n("br"),n("span",{staticClass:"line-number"},[s._v("34")]),n("br"),n("span",{staticClass:"line-number"},[s._v("35")]),n("br"),n("span",{staticClass:"line-number"},[s._v("36")]),n("br"),n("span",{staticClass:"line-number"},[s._v("37")]),n("br"),n("span",{staticClass:"line-number"},[s._v("38")]),n("br"),n("span",{staticClass:"line-number"},[s._v("39")]),n("br"),n("span",{staticClass:"line-number"},[s._v("40")]),n("br"),n("span",{staticClass:"line-number"},[s._v("41")]),n("br"),n("span",{staticClass:"line-number"},[s._v("42")]),n("br"),n("span",{staticClass:"line-number"},[s._v("43")]),n("br"),n("span",{staticClass:"line-number"},[s._v("44")]),n("br"),n("span",{staticClass:"line-number"},[s._v("45")]),n("br"),n("span",{staticClass:"line-number"},[s._v("46")]),n("br"),n("span",{staticClass:"line-number"},[s._v("47")]),n("br"),n("span",{staticClass:"line-number"},[s._v("48")]),n("br"),n("span",{staticClass:"line-number"},[s._v("49")]),n("br"),n("span",{staticClass:"line-number"},[s._v("50")]),n("br"),n("span",{staticClass:"line-number"},[s._v("51")]),n("br"),n("span",{staticClass:"line-number"},[s._v("52")]),n("br"),n("span",{staticClass:"line-number"},[s._v("53")]),n("br"),n("span",{staticClass:"line-number"},[s._v("54")]),n("br"),n("span",{staticClass:"line-number"},[s._v("55")]),n("br"),n("span",{staticClass:"line-number"},[s._v("56")]),n("br"),n("span",{staticClass:"line-number"},[s._v("57")]),n("br"),n("span",{staticClass:"line-number"},[s._v("58")]),n("br"),n("span",{staticClass:"line-number"},[s._v("59")]),n("br"),n("span",{staticClass:"line-number"},[s._v("60")]),n("br"),n("span",{staticClass:"line-number"},[s._v("61")]),n("br"),n("span",{staticClass:"line-number"},[s._v("62")]),n("br"),n("span",{staticClass:"line-number"},[s._v("63")]),n("br"),n("span",{staticClass:"line-number"},[s._v("64")]),n("br"),n("span",{staticClass:"line-number"},[s._v("65")]),n("br"),n("span",{staticClass:"line-number"},[s._v("66")]),n("br")])]),n("p",[s._v("基本上，grub2 不希望你自己修改 grub.cfg 这个配置文件，取代他们的是修改几个特定的配置文件，由  grub2-mkconfig 指令来产生新的 grub.cfg 文件，这里需要了解下 grub2.cfg 的大致内容")]),s._v(" "),n("ul",[n("li",[n("p",[n("code",[s._v("set root='hd0,gpt2'")])]),s._v(" "),n("p",[s._v("root  指定 grub2 的配置文件所在的设备。测试机来说，当初安装的时候分区出 "),n("code",[s._v("/")]),s._v(" 与 "),n("code",[s._v("/boot")]),s._v(" 两个设备，而 grub2 是在 "),n("code",[s._v("/boot/grup2")]),s._v(" 位置，该位置的磁盘文件名为 "),n("code",[s._v("/dev/sda2")]),s._v(" 因此就是 "),n("code",[s._v("(hd0,2)")]),s._v("，又因为是 gpt 分区，所以是 "),n("code",[s._v("(hd0,gpt2)")])])]),s._v(" "),n("li",[n("p",[n("code",[s._v("linux16 /vmlinuz-3.10.0-1062.el7.x86_64 root=/dev/mapper/centos-root")])]),s._v(" "),n("p",[s._v("Linux 核心文件以及核心执行时下达的参数。我们的核心文件应该是 "),n("code",[s._v("/boot/vmlinuz-xx")]),s._v("，这里怎么会在根目录呢？这与上面的 root 有关：")]),s._v(" "),n("ul",[n("li",[n("p",[s._v("如果没有 /boot 分区，仅有 / 分区：所以文件名是：")]),s._v(" "),n("p",[n("code",[s._v("/boot/vmlinuz-xxx ---\x3e (/)/boot/vmlinuz-xxx --\x3e (hd0,msdos1)/boot/vmlinuz-xx")])])]),s._v(" "),n("li",[n("p",[s._v("如果 /boot 是独立分区，则·")]),s._v(" "),n("p",[n("code",[s._v("/boot/vmlinuz-xxx --\x3e (/boot)/boot/vmlinuz-xx --\x3e (hd0,msdos1)/vmlinuz-xxx")])])])]),s._v(" "),n("p",[s._v("因此 linux16 后面接的文件名与上面的 root 搭配在一起，才是完整的绝对路径，至于文件名后面的 root=/dev/xx，中的 root 指 linux 文件系统中根目录是在哪个涉笔上的意思")])]),s._v(" "),n("li",[n("p",[n("code",[s._v("initrd16/initramfs-3.10..")])]),s._v(" "),n("p",[s._v("就是 initramfs 所在的文件名，与 linux16 哪个 vmlinuz-xxx 相同，也需要搭配 root，才是正确的位置")])])]),s._v(" "),n("h2",{attrs:{id:"grub2-的配置文件维护-etc-default-grub-与-etc-grub-d"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#grub2-的配置文件维护-etc-default-grub-与-etc-grub-d"}},[s._v("#")]),s._v(" grub2 的配置文件维护 "),n("code",[s._v("/etc/default/grub 与 /etc/grub.d")])]),s._v(" "),n("h3",{attrs:{id:"etc-default-grub-主要配置文件"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#etc-default-grub-主要配置文件"}},[s._v("#")]),s._v(" "),n("code",[s._v("/etc/default/grub")]),s._v(" 主要配置文件")]),s._v(" "),n("div",{staticClass:"language-bash line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@study ~"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# cat /etc/default/grub ")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("GRUB_TIMEOUT")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("5")]),s._v("\t\t\t\t\t\t\t\t"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 指定预设倒数读秒数，也就是只给出 n 秒让你操作")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("GRUB_DISTRIBUTOR")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"'),n("span",{pre:!0,attrs:{class:"token variable"}},[n("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$(")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("sed")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'s, release .*$,,g'")]),s._v(" /etc/system-release"),n("span",{pre:!0,attrs:{class:"token variable"}},[s._v(")")])]),s._v('"')]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("GRUB_DEFAULT")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("saved\t\t\t\t\t\t"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 指定默认由哪一个选单来开机")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("GRUB_DISABLE_SUBMENU")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("true\t\t\t"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 是否隐藏次选单，通常是隐藏起来的")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("GRUB_TERMINAL_OUTPUT")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"console"')]),s._v("\t"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 数据输出的终端机格式，默认是通过文字终端机")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 在 menuentry 括号内的 linux16 项目后续的核心参数")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("GRUB_CMDLINE_LINUX")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"crashkernel=auto spectre_v2=retpoline rd.lvm.lv=centos/root rd.lvm.lv=centos/swap rhgb quiet"')]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("GRUB_DISABLE_RECOVERY")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"true"')]),s._v("\t\t"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 取消救援选单的制作")]),s._v("\n\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br")])]),n("p",[s._v("下面讲解几个重要的设置（详情通过 info grub 6.1 章节阅读）")]),s._v(" "),n("ul",[n("li",[n("p",[s._v("倒数时间参数：GRUB_TIMEOUT")]),s._v(" "),n("p",[s._v("不想等待操作则输入 0，如果一定要求手动选择，则输入 -1，输入大于 0 秒的数值，则表示等待操作时间")])]),s._v(" "),n("li",[n("p",[s._v("是否隐藏选单：GRUB_TIMEOUT_STYLE")]),s._v(" "),n("p",[s._v("可设置的值有：")]),s._v(" "),n("ul",[n("li",[s._v("menu：显示选单（默认）")]),s._v(" "),n("li",[s._v("countdown：不显示选单，但是还显示读秒")]),s._v(" "),n("li",[s._v("hidden ：不显示选单，且不显示读秒")])]),s._v(" "),n("p",[s._v("等")])]),s._v(" "),n("li",[n("p",[s._v("信息输出终端机模式：GRUB_TERMINAL_OUTPUT")]),s._v(" "),n("p",[s._v("​\t输出的画面应该使用哪一个终端机来显示")]),s._v(" "),n("ul",[n("li",[s._v("console")]),s._v(" "),n("li",[s._v("serial")]),s._v(" "),n("li",[s._v("gfxterm")]),s._v(" "),n("li",[s._v("vag_text")])]),s._v(" "),n("p",[s._v("等")])]),s._v(" "),n("li",[n("p",[s._v("默认开机选单：GRUB_DEFAULT")]),s._v(" "),n("p",[s._v("默认使用哪一个选单（menuentry）来作为开机项目。能使用的设置值为")]),s._v(" "),n("ul",[n("li",[s._v("saved")]),s._v(" "),n("li",[s._v("数值")]),s._v(" "),n("li",[s._v("title")]),s._v(" "),n("li",[s._v("ID")])]),s._v(" "),n("p",[s._v("等，假设你有三个 menuentry")]),s._v(" "),n("div",{staticClass:"language-bash line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[s._v("menuentry  "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'1st linux system'")]),s._v(" --id 1lst-linux-system "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v("."),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\nmenuentry  "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'2nd linux system'")]),s._v(" --id 2nd-linux-system "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v("."),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\nmenuentry  "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'3rd linux system'")]),s._v(" --id 3rd-linux-system "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v("."),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\n几个常见的设置如下含义：\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 表示使用第 2 个 menuentry 开机，数值编号以 0 开始")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("GRUB_DEFAULT")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 表示使用第 3 个")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("GRUB_DEFAULT")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("3rd linux system\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 表示使用 grub2-set-default 来设置哪一个 menuentry。通常预设为 0")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("GRUB_DEFAULT")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("saved\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br")])])]),s._v(" "),n("li",[n("p",[s._v("核心的外加参数功能：GRUB_CMDLINE_LINUX")]),s._v(" "),n("p",[s._v("可以在核心启动时加入额外的参数，在这里加入。比如，除了预设的核心参数外，还需要让你的磁盘读写机制为 deadline 时，可以这样处理")]),s._v(" "),n("div",{staticClass:"language-bash line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[n("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("GRUB_CMDLINE_LINUX")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"... crashkernel=atuo rhgb quiet elevator=deadline"')]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])])])]),s._v(" "),n("p",[s._v("这个主要环节配置文件配置完成后，必须使用 grub2-mkconfig 来重建 grub.cfg 才可以。因为主配置文件是 grub.cfg，我们是通过许多脚本来协助完成 grub.cfg 的自动建立。另外，额外自己设置的项目，写入 "),n("code",[s._v("/etc/default/grub")]),s._v(" 文件内")]),s._v(" "),n("p",[s._v("下面进行联系")]),s._v(" "),n("p",[s._v("问题：达成以下要求")]),s._v(" "),n("ol",[n("li",[s._v("开机选单等待 40 秒")]),s._v(" "),n("li",[s._v("预设使用第一个选单开机")]),s._v(" "),n("li",[s._v("选单请显示出来，不要隐藏")]),s._v(" "),n("li",[s._v("核心外带参数 "),n("code",[s._v("elevator=deadline")])])]),s._v(" "),n("p",[s._v("直接编辑主要环节配置文件后，再以 grub2-mkconfg 来重建 grub.cfg")]),s._v(" "),n("div",{staticClass:"language-bash line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 1. 编辑主要环节配置文件")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@study ~"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# cat /etc/default/grub ")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("GRUB_TIMEOUT")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("40")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("GRUB_DISTRIBUTOR")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"'),n("span",{pre:!0,attrs:{class:"token variable"}},[n("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$(")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("sed")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'s, release .*$,,g'")]),s._v(" /etc/system-release"),n("span",{pre:!0,attrs:{class:"token variable"}},[s._v(")")])]),s._v('"')]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("GRUB_DEFAULT")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("GRUB_DISABLE_SUBMENU")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("true\n"),n("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("GRUB_TERMINAL_STYLE")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("menu\n"),n("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("GRUB_TERMINAL_OUTPUT")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"console"')]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("GRUB_CMDLINE_LINUX")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"crashkernel=auto spectre_v2=retpoline rd.lvm.lv=centos/root rd.lvm.lv=centos/swap rhgb quiet elevator=deadline"')]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("GRUB_DISABLE_RECOVERY")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"true"')]),s._v("\n\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 2. 重建 grub.cfg")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@study default"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# grub2-mkconfig -o /boot/grub2/grub.cfg")]),s._v("\nGenerating grub configuration "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("file")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v(".\nFound linux image: /boot/vmlinuz-3.10.0-1062.el7.x86_64\nFound initrd image: /boot/initramfs-3.10.0-1062.el7.x86_64.img\nFound linux image: /boot/vmlinuz-0-rescue-f228ab37c368416c84c6b27971ba45a9\nFound initrd image: /boot/initramfs-0-rescue-f228ab37c368416c84c6b27971ba45a9.img\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("done")]),s._v("\n\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 3. 检查是否生效")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@study default"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# grep timeout /boot/grub2/grub.cfg ")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v(" x"),n("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$feature_timeout_style")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" xy "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("then")]),s._v("\n  "),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("set")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("timeout_style")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("menu\n  "),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("set")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("timeout")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("40")]),s._v("\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# from /etc/grub.d and settings from /etc/default/grub")]),s._v("\n   "),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("set")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("default")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"'),n("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${next_entry}")]),s._v('"')]),s._v("\n   "),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("set")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("default")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"0"')]),s._v("\n   \n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@study default"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# grep linux16 /boot/grub2/grub.cfg ")]),s._v("\n        linux16 /vmlinuz-3.10.0-1062.el7.x86_64 "),n("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("root")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("/dev/mapper/centos-root ro "),n("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("crashkernel")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("auto "),n("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("spectre_v2")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("retpoline rd.lvm.lv"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("centos/root rd.lvm.lv"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("centos/swap rhgb quiet "),n("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("elevator")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("deadline \n        linux16 /vmlinuz-0-rescue-f228ab37c368416c84c6b27971ba45a9 "),n("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("root")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("/dev/mapper/centos-root ro "),n("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("crashkernel")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("auto "),n("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("spectre_v2")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("retpoline rd.lvm.lv"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("centos/root rd.lvm.lv"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("centos/swap rhgb quiet "),n("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("elevator")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("deadline \n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br"),n("span",{staticClass:"line-number"},[s._v("22")]),n("br"),n("span",{staticClass:"line-number"},[s._v("23")]),n("br"),n("span",{staticClass:"line-number"},[s._v("24")]),n("br"),n("span",{staticClass:"line-number"},[s._v("25")]),n("br"),n("span",{staticClass:"line-number"},[s._v("26")]),n("br"),n("span",{staticClass:"line-number"},[s._v("27")]),n("br"),n("span",{staticClass:"line-number"},[s._v("28")]),n("br"),n("span",{staticClass:"line-number"},[s._v("29")]),n("br"),n("span",{staticClass:"line-number"},[s._v("30")]),n("br"),n("span",{staticClass:"line-number"},[s._v("31")]),n("br"),n("span",{staticClass:"line-number"},[s._v("32")]),n("br"),n("span",{staticClass:"line-number"},[s._v("33")]),n("br"),n("span",{staticClass:"line-number"},[s._v("34")]),n("br"),n("span",{staticClass:"line-number"},[s._v("35")]),n("br")])]),n("p",[s._v("通过以上测试，可以知道给我们一个配置文件，然后通过指令去刷新主配置文件，这能降低我们手动操作主配置文件的难度")]),s._v(" "),n("h3",{attrs:{id:"选单建立的脚本-etc-grub-d"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#选单建立的脚本-etc-grub-d"}},[s._v("#")]),s._v(" 选单建立的脚本 "),n("code",[s._v("/etc/grub.d/*")])]),s._v(" "),n("p",[s._v("执行 "),n("code",[s._v("grub2-mkconfig -o /boot/grub2/grub.cfg")]),s._v(" 后，显示信息去抓取了 linux 核心等信息，这是因为 grub2-mkconfig 去分析 "),n("code",[s._v("/etc/grub.d/*")]),s._v(" 中的文件，然后执行该文件来建立 grub.cfg 文件。该目录下一般或存储以下文件")]),s._v(" "),n("ul",[n("li",[n("p",[n("code",[s._v("00_header:")])]),s._v(" "),n("p",[s._v("主要在建立初始的显示项目，包括需要加载的模块分析、屏幕终端机的格式、倒数描述、选单是否需要隐藏等，大部分在 "),n("code",[s._v("/etc/default/grub")]),s._v(" 里所设置的变量，大概都会在该脚本中被利用来写入 grub.cfg 中")])]),s._v(" "),n("li",[n("p",[n("code",[s._v("10_linux")])]),s._v(" "),n("p",[s._v("根据分析 "),n("code",[s._v("/boot")]),s._v(" 下的文件，尝试找到正确的 Linux 核心与读取该核心需要的文件系统模块与参数等信息，都在该脚本运行后找到并设置到 grub.cfg 中。")]),s._v(" "),n("p",[s._v("因为该脚本会将所有在 "),n("code",[s._v("/boot")]),s._v(" 下的每一个核心文件都对应到一个选单上，因此核心文件数量越多，你的开机选单项目就越多")]),s._v(" "),n("p",[s._v("如果不需要旧的核心出现在选单上，可以通过移除旧核心来处理")])]),s._v(" "),n("li",[n("p",[n("code",[s._v("30_os-prober")])]),s._v(" "),n("p",[s._v("默认会到系统上找其他的 partition 里面可能含有的操作系统，然后将该操作系统做成选单来处理。")]),s._v(" "),n("p",[s._v("如果不想要让其他操作系统被检测到并制作开机选单，可以在 "),n("code",[s._v("/etc/default/grub")]),s._v(" 中加上 "),n("code",[s._v("GRUB_DISABLE_OS_PROBER=true")]),s._v(" 来取消该文件的运行")])]),s._v(" "),n("li",[n("p",[n("code",[s._v("40_custom")])]),s._v(" "),n("p",[s._v("如果还有其他自定义加上的选单项目，或则其他需求，可以在这里进行补充")])])]),s._v(" "),n("p",[s._v("一般来说，我们会修改 40_custom 文件。现在我们知道 menuentry 是一个选单，它的功能有如下：")]),s._v(" "),n("ul",[n("li",[n("p",[s._v("直接指定核心开机")]),s._v(" "),n("p",[s._v("基本上如果是 Linux 的核心要直接被用来开机，直接通过 grub2-mkconfg 去抓取 "),n("code",[s._v("10_linux")]),s._v(" 脚本来制作即可，但是如果你有额外比较特别的参数需要进行，可以这样做")]),s._v(" "),n("ol",[n("li",[s._v("先到 grub.cfg 取得你要制作的核心选单项目，让后将它复制到 40_custom 中")]),s._v(" "),n("li",[s._v("再到 40_custom 中根据你的需求修改即可")])]),s._v(" "),n("p",[s._v("问题：如果你想要使用第一个原有的 menuentry 取出来后，增加一个选单，该选单可以强制 systemd 使用 graphical.target 来启动 linux 系统，让选单一定可以使用图形界面而不用理会 default.target 的连结。如何做？")]),s._v(" "),n("div",{staticClass:"language-bash line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[s._v("在核心外带参数中，有个选项 systemd.unit"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("???，可以做到。因此先到 grub.cfg 中，复制一个 menuentry\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@study default"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# vim /etc/grub.d/40_custom")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#在这里修改我们的选单名称")]),s._v("\nmenuentry "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'My graphical CentOS'")]),s._v(" --class centos --class gnu-linux --class gnu --class os --unrestricted --id "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'mygraphical'")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("   "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 这里再设置一个 --id")]),s._v("\n        load_video\n        "),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("set")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("gfxpayload")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("keep\n        insmod gzio\n        insmod part_gpt\n        insmod xfs\n        "),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("set")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("root")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'hd0,gpt2'")]),s._v("\n        "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v(" x"),n("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$feature_platform_search_hint")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" xy "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("then")]),s._v("\n          search --no-floppy --fs-uuid --set"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("root --hint-bios"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("hd0,gpt2 --hint-efi"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("hd0,gpt2 --hint-baremetal"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("ahci0,gpt2  13d0663f-4cbd-412d-aa9f-975eb18da590\n        "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("else")]),s._v("\n          search --no-floppy --fs-uuid --set"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("root 13d0663f-4cbd-412d-aa9f-975eb18da590\n        "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("fi")]),s._v("\n        linux16 /vmlinuz-3.10.0-1062.el7.x86_64 "),n("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("root")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("/dev/mapper/centos-root ro "),n("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("crashkernel")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("auto "),n("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("spectre_v2")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("retpoline rd.lvm.lv"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("centos/root rd.lvm.lv"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("centos/swap rhgb quiet "),n("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("elevator")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("deadline systemd.unit"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("graphical.target  "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 这里再增加 systemd.unit=graphical.target 配置")]),s._v("\n        initrd16 /initramfs-3.10.0-1062.el7.x86_64.img\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 然后重建下")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@study default"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# grep linux16 /boot/grub2/grub.cfg ")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 下次重新开机的时候就会出现该选单给你选择了")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br"),n("span",{staticClass:"line-number"},[s._v("22")]),n("br")])]),n("h3",{attrs:{id:"通过-chainloader-的方式移交-loader-控制权"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#通过-chainloader-的方式移交-loader-控制权"}},[s._v("#")]),s._v(" 通过 chainloader 的方式移交 loader 控制权")]),s._v(" "),n("p",[s._v("chain loader ：开机管理程序的连结，仅是在将控制权交给下一个 boot loader。所以 grub2 并不需要认识与找出 kernel 的文件，只是将 boot 的控制权交给下一个 boot sector 或 MBR 内的 boot loader 而已，所以通常它也不需要去检查下一个 boot loader 的文件系统")]),s._v(" "),n("p",[s._v("一般来说，chain loader 的设置值要两个就够了：")]),s._v(" "),n("ol",[n("li",[s._v("预计要前往的 boot sector 所在的分区槽代号")]),s._v(" "),n("li",[s._v("设置 chainloader 在那个分区槽的 boot sector （第一个扇区）上")])]),s._v(" "),n("p",[s._v("假设 windows 分区槽在 "),n("code",[s._v("/dev/sda1")]),s._v(" ,但是我只有一块硬盘，那么要 grub 将控制权交给 windows loader 需要这样做")]),s._v(" "),n("div",{staticClass:"language-bash line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[s._v("menuentry "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"Windows"')]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n\tinsmod chain\t\t"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 加载 chainloader 的模块")]),s._v("\n\tinsmod ntfs\t\t\t"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 建议加入 windows 所在的文件系统模块较好")]),s._v("\n\t"),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("set")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("root")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("hd0,1"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\t"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 是在哪一个分区槽？")]),s._v("\n\tchainloader +1 \t\t"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 去 boot sector 将 loader 软件读取出来的意思")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 通过以上配置，就可以让 grub2 叫出控制权了")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br")])]),n("p",[s._v("问题：假设你的测试系统上使用 MBR 分区槽，并且出现如下数据")]),s._v(" "),n("div",{staticClass:"language-bash line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@study ~"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# fdisk -l /dev/sda ")]),s._v("\nDevice Boot         Start           End    \tBlocks  \t\tId    System\n/dev/sda1 \t\t\t\t\t   "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("2048")]),s._v("         "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("6143")]),s._v("     "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("44444")]),s._v("\t\t\t"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("83")]),s._v("\t\tLinux\n/dev/sda2 *\t\t\t\t\t   "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("6144")]),s._v("      "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("2103295")]),s._v("     "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("999999")]),s._v("\t\t\t"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("7")]),s._v("\t\t  HPFS/NTFS/exFAT\n/dev/sda3 \t\t\t\t\t"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("2103296")]),s._v("     "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("65026047")]),s._v("     "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("222222")]),s._v("\t\t\t"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("84")]),s._v("\t\tLinux\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 其中 /dev/sda2 是 windows 7 操作系统，现在需要增加两个开机选项")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 1. 获取 windows7 的开机选单")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 2. 回到 MBR 的预设环境")]),s._v("\n\n\nwin7 在 /dev/sda2，因此是 hd0,msdos2，而 MBR 则是 hd0 即可，因此设置如下\n\n"),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("vim")]),s._v(" /etc/grub.d/40_custom\nmenuentry "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'Go to Windows 7'")]),s._v(" --id "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'win7'")]),s._v("  "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n\tinsmod chain\t\t\n\tinsmod ntfs\t\t\t\n\t"),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("set")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("root")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("hd0,2"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\t\n\tchainloader +1 \t\t\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\nmenuentry "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'go to MBR'")]),s._v(" --id "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'mbr'")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n\tinsmod chain\t\t\t\n\t"),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("set")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("root")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("hd0"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\tchainloader +1\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 如果每次都想要 windows 变成默认的开机选项，")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 那么在 /etc/default/grub 中设置 GRUB_DEFAULT=win7")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 再使用 grub2-mkconfig 即可，通过 --id 来处理，不需要去计算  menuentry 的顺序")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br"),n("span",{staticClass:"line-number"},[s._v("22")]),n("br"),n("span",{staticClass:"line-number"},[s._v("23")]),n("br"),n("span",{staticClass:"line-number"},[s._v("24")]),n("br"),n("span",{staticClass:"line-number"},[s._v("25")]),n("br"),n("span",{staticClass:"line-number"},[s._v("26")]),n("br"),n("span",{staticClass:"line-number"},[s._v("27")]),n("br"),n("span",{staticClass:"line-number"},[s._v("28")]),n("br"),n("span",{staticClass:"line-number"},[s._v("29")]),n("br"),n("span",{staticClass:"line-number"},[s._v("30")]),n("br")])]),n("h2",{attrs:{id:"initramfs-的重要性与监理新-initramfs-文件"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#initramfs-的重要性与监理新-initramfs-文件"}},[s._v("#")]),s._v(" initramfs 的重要性与监理新 initramfs 文件")]),s._v(" "),n("p",[s._v("在前面提到过 initramfs，它的目的是在于提供开机过程中所需要的最重要核心模块，让系统开机过程可以顺利完成。")]),s._v(" "),n("p",[s._v("一般来说，需要 initramfs 的时刻有：")]),s._v(" "),n("ul",[n("li",[s._v("根目录所在磁盘为 STAT、USB 或 SCSI 等连接接口")]),s._v(" "),n("li",[s._v("根目录所在文件系统为 LVM、RAID 等特殊格式")]),s._v(" "),n("li",[s._v("根目录所在文件系统为非传统 LInux 认识的文件系统时")]),s._v(" "),n("li",[s._v("其他必须要在核心加载时提供的模块")])]),s._v(" "),n("p",[s._v("一般来说，各 distribution 提供的核心都会附上 initramfs 文件，但是如果你有特殊需要想重新制作 initramfs 文件的话，可以使用 "),n("code",[s._v("dracut\\mkinitrd")]),s._v(" 来处理")]),s._v(" "),n("p",[s._v("在 CentOS 7 下应该使用 dracut，这里也主要介绍它")]),s._v(" "),n("div",{staticClass:"language-bash line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[s._v("dracut "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("-fv"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("--add-drivers 列表"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" initramfs 文件名 核心版本\n\n选项与参数：\n\n\t-f：强迫编译出 initramfs，如果 initramfs 文件已经存在，则覆盖旧文件\n\t-v：显示 dracut 的运行过程\n\t--add-drivers 列表：在原本的默认核心模块中，增加某些你想要的模块，模块维护核心所在目录 "),n("span",{pre:!0,attrs:{class:"token variable"}},[n("span",{pre:!0,attrs:{class:"token variable"}},[s._v("`")]),s._v("/lib/modules/"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("$(")]),s._v("uname -r"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("/kernel/*"),n("span",{pre:!0,attrs:{class:"token variable"}},[s._v("`")])]),s._v("\n\tinitramfs 文件名：你需要的文件名，开头最好以 initramfs，后面接版本与功能\n\t核心版本：默认是目前运行中的核心版本，也可以手动输入其他不同版本\n\t\n\tdracut 还有很多功能。例如下面的几个参数：\n\t--modules：将 dracut 所提供的开机锁需模块（核心模块）加载，可用模块在 /usr/lib/dracut/modules.d/ 目录\n\t--gzip"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("--bzip2"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("--xz：尝试使用哪一种压缩方式来进行 initramfs 压缩，默认使用 "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("gzip")]),s._v("\n\t--filesystem：加入某些额外的文件系支持 \n\t\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 范例 1：以 dracut 的默认功能建立一个 initramfs 虚拟盘文件")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@study ~"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# dracut -v initramfs-test.img $(uname -r)")]),s._v("\nExecuting: /sbin/dracut -v initramfs-test.img "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("3.10")]),s._v(".0-1062.el7.x86_64\ndracut module "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'busybox'")]),s._v(" will not be installed, because "),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("command")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'busybox'")]),s._v(" could not be found"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("!")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v(".\ndracut module "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'cifs'")]),s._v(" will not be installed, because "),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("command")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'mount.cifs'")]),s._v(" could not be found"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("!")]),s._v("\n*** Including module: "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("bash")]),s._v(" ***\n*** Including module: nss-softokn ***\n*** Including module: i18n ***\n*** Including module: network ***\n*** Including module: ifcfg ***\n*** Including module: drm ***\n*** Including module: plymouth ***\n*** Including module: dm ***\nSkipping udev rule: "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("64")]),s._v("-device-mapper.rules\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v("\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 范例 2：额外加入 e100e 网卡驱动与 ext4/nfs 文件系统在新的 initramfs 内")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@study ~"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v('# dracut -v --add-drivers "e10001" --filesystems "ext4 nfs" initramfs-new.img $(uname -r)')]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@study ~"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# lsinitrd initramfs-new.img | grep -E '(e1000|ext4|nfs)'")]),s._v("\nArguments: -v --add-drivers "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'e10001'")]),s._v(" --filesystems "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'ext4 nfs'")]),s._v("\nnfs\n-rw-r--r--   "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" root     root           "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("15")]),s._v(" Mar "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("29")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("21")]),s._v(":52 etc/modprobe.d/nfs.conf\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v(".\n\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br"),n("span",{staticClass:"line-number"},[s._v("22")]),n("br"),n("span",{staticClass:"line-number"},[s._v("23")]),n("br"),n("span",{staticClass:"line-number"},[s._v("24")]),n("br"),n("span",{staticClass:"line-number"},[s._v("25")]),n("br"),n("span",{staticClass:"line-number"},[s._v("26")]),n("br"),n("span",{staticClass:"line-number"},[s._v("27")]),n("br"),n("span",{staticClass:"line-number"},[s._v("28")]),n("br"),n("span",{staticClass:"line-number"},[s._v("29")]),n("br"),n("span",{staticClass:"line-number"},[s._v("30")]),n("br"),n("span",{staticClass:"line-number"},[s._v("31")]),n("br"),n("span",{staticClass:"line-number"},[s._v("32")]),n("br"),n("span",{staticClass:"line-number"},[s._v("33")]),n("br"),n("span",{staticClass:"line-number"},[s._v("34")]),n("br"),n("span",{staticClass:"line-number"},[s._v("35")]),n("br"),n("span",{staticClass:"line-number"},[s._v("36")]),n("br"),n("span",{staticClass:"line-number"},[s._v("37")]),n("br"),n("span",{staticClass:"line-number"},[s._v("38")]),n("br"),n("span",{staticClass:"line-number"},[s._v("39")]),n("br"),n("span",{staticClass:"line-number"},[s._v("40")]),n("br")])]),n("p",[s._v("建立完成之后，同时核心也处理完成后，就可以使用 grub2 来建立选单了。下面继续")])])]),s._v(" "),n("h2",{attrs:{id:"测试与安装-grub2"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#测试与安装-grub2"}},[s._v("#")]),s._v(" 测试与安装 grub2")]),s._v(" "),n("p",[s._v("如果你的 Linux 主机本来就使用 grub2 作为 loader 的话，就不需要重新安装了，如果并非使用 grub2，那么需要安装")]),s._v(" "),n("p",[s._v("首先：必须使用 grub-install 将一些必要的文件复制到 /boot/grub2 中，应该这样做")]),s._v(" "),n("div",{staticClass:"language-bash line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[s._v("grub2-install "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("-boot-directory"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("DIR"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" INSTALL_DEVIVCE\n\n--boot-directory"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("DIR：DIR 是实际的目录，使用 grub2-install 默认会将 grub2 所有的文件都复制到 "),n("span",{pre:!0,attrs:{class:"token variable"}},[n("span",{pre:!0,attrs:{class:"token variable"}},[s._v("`")]),s._v("/boot/grub2/*"),n("span",{pre:!0,attrs:{class:"token variable"}},[s._v("`")])]),s._v(" ，如果想复制到其他目录与设备，需要使用该参数\nINSTALL_DEVIVCE：安装设置代号\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br")])]),n("div",{staticClass:"language-bash line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 范例 1： 将 grub2 安装在目录系统的 MBR 下，我的系统为 /dev/sda")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@study ~"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# grub2-install /dev/sda")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 如果原来就是 grub2，所以可能不会有什么特别的信息")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 但是去查看相关文件更新日期会发现被更新过了，因为是重装")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 但是我们并没有配置文件，需要自己创建")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br")])]),n("p",[s._v("基本上，grub2-install 大概仅安装 grub2 主程序与相关软件到 "),n("code",[s._v("/boot/grub2")]),s._v(" 目录，如果后面的设备是整个系统 (/dev/sda、/dev/vds ...)，那 loader 的程序才会写入到 MBR 中去。")]),s._v(" "),n("p",[s._v("如果 XFS 文件系统的 /dev/sda2 设备（个别 partition），那么 grub2-install 就会告诉你，该文件系统并不支持 grub2 的安装。")]),s._v(" "),n("p",[s._v("下面强迫写入试试")]),s._v(" "),n("div",{staticClass:"language-bash line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 尝试看看你的系统中是否有 xfs 文件系统，且为传统的 parition 类型")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@study ~"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# df -T | grep -i xfs")]),s._v("\n/dev/mapper/centos-root xfs       "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("10475520")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("5475932")]),s._v("   "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("4999588")]),s._v("  "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("53")]),s._v("% /\n/dev/sda2               xfs        "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("1038336")]),s._v("  "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("184348")]),s._v("    "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("853988")]),s._v("  "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("18")]),s._v("% /boot\n/dev/mapper/centos-home xfs        "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("5232640")]),s._v("  "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("949064")]),s._v("   "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("4283576")]),s._v("  "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("19")]),s._v("% /home\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 笔者这里没有其他的分区。直接把书上的分区列出来")]),s._v("\n/dev/vda4\t\t\t\t\t\t\t  xfs        "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("5232640")]),s._v("  "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("949064")]),s._v("   "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("4283576")]),s._v("  "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("19")]),s._v("% /srv/myproject\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 那么下面使用 /dev/vda4 来安装")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@study ~"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# grub2-install /dev/vda4")]),s._v("\ngrub2-install: error: hostdisk/dev/vda appears to con"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("--skip-fs-probe "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 报错了，恐怕不支持你的 boot sector ，这应该是误判，使用强制安装")]),s._v("\n\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@study ~"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# grub2-install --skip-fs-probe /dev/vda4")]),s._v("\nInstalling "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("for")]),s._v(" i386-pc platform.\ngrub2-install:warning: FIle system "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'xfs'")]),s._v(" doesn‘t support embedding\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v("\ngrub2-install:error: will not proceed with blocklists\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 还是失败，因为还是担心 xfs 被搞死，使用如下参数再测一次")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@study ~"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# grub2-install --force --recheck --skip-fs-probe /dev/vda4")]),s._v("\nInstalling "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("for")]),s._v(" i386-pc platform.\ngrub2-install:warning: FIle system "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'xfs'")]),s._v(" doesn‘t support embedding\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v("\nInstallation finished.NO error reporled\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 安装好了，只出现了警告信息，但是错误没有了")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br"),n("span",{staticClass:"line-number"},[s._v("22")]),n("br"),n("span",{staticClass:"line-number"},[s._v("23")]),n("br"),n("span",{staticClass:"line-number"},[s._v("24")]),n("br"),n("span",{staticClass:"line-number"},[s._v("25")]),n("br"),n("span",{staticClass:"line-number"},[s._v("26")]),n("br")])]),n("p",[s._v("上面这样将 grub2 的主程序安装到 /dev/vda4 以及重新安装到 MBR 里面去了。")]),s._v(" "),n("p",[s._v("思考下：grub2 主程序会找 grub.cfg 文件，大多是在 /boot/grub2/grub.cfg 里。那么我们的 MBR 与 /dev/vda4 都是到 /boot/grub2/grub.cfg 去抓设置吗？如果是多重操作系统怎么办？")]),s._v(" "),n("div",{staticClass:"language-bash line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 问：假设你的测试系统上使用 MBR 分区槽，并且出现如下数据")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@study ~"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# fdisk -l /dev/sda ")]),s._v("\nDevice Boot         Start           End    \tBlocks  \t\tId    System\n/dev/sda1 \t\t\t\t\t   "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("2048")]),s._v("         "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("6143")]),s._v("     "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("44444")]),s._v("\t\t\t"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("83")]),s._v("\t\tLinux\n/dev/sda2 *\t\t\t\t\t   "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("6144")]),s._v("      "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("2103295")]),s._v("     "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("999999")]),s._v("\t\t\t"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("7")]),s._v("\t\t  HPFS/NTFS/exFAT\n/dev/sda3 \t\t\t\t\t"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("2103296")]),s._v("     "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("65026047")]),s._v("     "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("222222")]),s._v("\t\t\t"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("84")]),s._v("\t\tLinux\n\nsda1 与 sda3 是两个 CentOS "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("7")]),s._v(" 系统。\nsda2 是一个 windows7 系统\n安装流程是 sda1、sda2、sda3 ，因此安装好而且重启后，系统其实是默认进入 sda3 这个 CentOS "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("7")]),s._v(" 系统的。此时 MBR 会去读取的配置文件在 "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("/dev/sda3"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("/boot/grub2/grub.cfg\n\n因为 sda1 应该是用来管理开机选单的，而 sda2 以及 sda3 在规划中就是用来让学生操作的，因此默认情况下  sda1 内的 CentOS 系统应该只会在开机的使用用到，或则是出问题时才会用到。\n而 sd2 与 sd3 则可能因为学生无用，因此未来可能会升级或删除或重装等，\n那如何让系统永远都是使用 /dev/sda1 开机？\n\n答：因为 MBR 的 boot loader 应该去 "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("/dev/sda1"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("/boot/grub2/grub.cfg 读取相关设置才是正常的，所以可以使用集中基本的方式来处理：\n\n"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(". 因为 CentOS "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("7")]),s._v(" 会主动找其他操作系统，因此可以在 sda3 的开机选单中找到 sda1 的开机选项，使用该选项进入系统，就可以进入 sda1 了\n"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v(". 假设没能抓到 sda1，那可以在 sda3 下使用 "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("chroot")]),s._v(" 来进入 sda1\n"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),s._v("、 使用救援光盘去抓到正确的 sda1.然后去的 sda1 的系统\n\n等进入到系统之后，修改 /etc/default/grub 以及 /etc/grub.d/40_custom 后，使用 grub2-mkconfig -o / boot/grb2/grub.cfg. 然后重新  grub2-install/dev/sda 就能够让你的 MBR 去获取 /dev/sda1 内的配置文件了\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br"),n("span",{staticClass:"line-number"},[s._v("22")]),n("br")])]),n("div",{staticClass:"language-bash line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 问：前面的练习，测试机目前为 40 秒倒数，且有一个强制进入图形界面 My graphical CentOS 7 的选单")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 现在需要多加两个选单，一个是回到 MBR 的 chainloader ")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 一个使用 sda4 的 chainloadder 该如何处理？")]),s._v("\n\n"),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("vim")]),s._v(" /etc/grub.d/40_custom\n"),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("vim")]),s._v(" /etc/grub.d/40_custom\nmenuentry "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'Goto MBR'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n\tinsmod chain\t\t\n\tinsmod part_gpt\t\t\t\n\t"),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("set")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("root")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("hd0"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\t\n\tchainloader +1 \t\t\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\nmenuentry "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'Goto /dev/sda4'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n\tinsmod chain\t\t\t\n\tinsmod part_gpt\t\t\t\n\t"),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("set")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("root")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("hd0.gpt4"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\tchainloader +1\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\ngrub2-mkconfig -o /boot/grub2/grub.cfg\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br")])]),n("p",[s._v("最后总结：")]),s._v(" "),n("ol",[n("li",[n("p",[s._v("如何是从其他 boot loader 转成 grub2 时，需要先使用 grub2-install 安装 grub2 配置文件")]),s._v(" "),n("p",[s._v("如果安装到 partition 时，可能需要加上额外的许多参数才能够顺利安装")])]),s._v(" "),n("li",[n("p",[s._v("开始编辑 "),n("code",[s._v("/etc/default/grub 以及 /etc/grub.d/*")]),s._v(" 重要的配置文件")])]),s._v(" "),n("li",[n("p",[s._v("使用 "),n("code",[s._v("grub2-mkconfig -o /boot/grub2/grub.cfg")]),s._v(" 来建立开机的配置文件")])])]),s._v(" "),n("h2",{attrs:{id:"开机前的额外功能修改"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#开机前的额外功能修改"}},[s._v("#")]),s._v(" 开机前的额外功能修改")]),s._v(" "),n("p",[s._v("前面部分由于没有额外的分区，没有跟着做，导致这里无法显示没有做的那一部分选单，该章节直接使用书上的截图")]),s._v(" "),n("p",[n("img",{attrs:{src:a(503),alt:"image-20200331214428334"}})]),s._v(" "),n("p",[s._v("上面的 ‘e’ ，表示按 e 键可以进入编辑模式，直接对该选项进行编辑")]),s._v(" "),n("p",[n("img",{attrs:{src:a(504),alt:"image-20200331214650243"}})]),s._v(" "),n("p",[s._v("上面就是我们在 grub.cfg 里的配置的内容，这里可以直接修改。下半部分则是一些说明，可以使用 ctrl + x 重启，ctrl + c 或 esc 可返回上个画面")]),s._v(" "),n("p",[s._v("问题：在线编辑，让系统进入救援模式 （rescue），而不像要进入系统后使用 systemctl rescue 时，怎么做？")]),s._v(" "),n("p",[s._v("答：可使用在线编辑模式，找到下图的 linux16 的项，然后添加服务参数")]),s._v(" "),n("p",[n("img",{attrs:{src:a(505),alt:"image-20200331215159375"}})]),s._v(" "),n("p",[s._v("修改之后，再重启就可以直接进入救援模式了")]),s._v(" "),n("p",[n("img",{attrs:{src:a(506),alt:"image-20200331215301052"}})]),s._v(" "),n("p",[s._v("进入 runlevel 需要输入密码？后续会讲解如何处理（不输入密码）")]),s._v(" "),n("h2",{attrs:{id:"关于开机画面与终端机画面的图形显示方式"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#关于开机画面与终端机画面的图形显示方式"}},[s._v("#")]),s._v(" 关于开机画面与终端机画面的图形显示方式")]),s._v(" "),n("p",[s._v("如果想用开机画面使用图形显示方式，如使用中文来显示开机画面。我们预设的 locale 的语系是 "),n("code",[s._v("zh_CN.UTF-8")]),s._v("，所以理论上会显示中文才对，可以修改 grub.cfg 来达成")]),s._v(" "),n("div",{staticClass:"language-bash line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@study ~"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# vim /etc/default/grub")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v(".\n"),n("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("GRUB_TERMINAL")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("gfxterm\t\t\t\t\t"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 设置主要的终端机显示为图形界面")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("GRUB_GFXMODE")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("1024x768x24\t\t\t"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 图形界面的 x、y、彩度信息")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("GRUB_GFPAYLOAD_LINUX")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("keep\t\t\t"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 保留图形界面，不要使用 text")]),s._v("\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 重新建立配置文件")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@study ~"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# grub2-mkconfig -o /boot/grub2/grub.cfg ")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br")])]),n("p",[s._v("重启时，就能看到如下的画面了")]),s._v(" "),n("p",[n("img",{attrs:{src:a(507),alt:"image-20200331220333935"}})]),s._v(" "),n("p",[s._v("后面这个开机选单中的中文是修改 menuentry 出来的，不是自动出来的哈")]),s._v(" "),n("h2",{attrs:{id:"为个别选单加上密码"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#为个别选单加上密码"}},[s._v("#")]),s._v(" 为个别选单加上密码")]),s._v(" "),n("p",[s._v("前面在讲解可以在开机时进入 grub2 的指令画面进入修改选单参数等，如果是在公共教室情况下，想要加密某个选单还是有必要的")]),s._v(" "),n("p",[s._v("grub2 的控制有：")]),s._v(" "),n("ol",[n("li",[n("p",[s._v("grub2 的选单指令列修改")])]),s._v(" "),n("li",[n("p",[s._v("进入选择的选单开机流程")])])]),s._v(" "),n("p",[s._v("要使用密码的话，就涉及到 grub2 的账户机制了")]),s._v(" "),n("h3",{attrs:{id:"grub2-的账户、密码与选单设置"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#grub2-的账户、密码与选单设置"}},[s._v("#")]),s._v(" grub2 的账户、密码与选单设置")]),s._v(" "),n("p",[s._v("在 grub2 的选单管理中，针对两种身份进行密码设置：")]),s._v(" "),n("ul",[n("li",[n("p",[s._v("superusers：")]),s._v(" "),n("p",[s._v("设置系统管理员与相关参数还有密码等，使用这个密码的用户，将可再 grub2 内具有所有修改的权限。但一旦设置了这个参数，则所有的指令修改将会受到限制")])]),s._v(" "),n("li",[n("p",[s._v("users")]),s._v(" "),n("p",[s._v("设置一般账户的相关参数与密码，可以设置多个账户，使用该密码的用户可以选择要进入某些选单项目。不过，选单项目也需要搭配相对应的账户才可以")]),s._v(" "),n("p",[s._v("一般来说，使用这种密码的账户并不能修改选单的内容，仅能选择进入选单去开机")])])]),s._v(" "),n("p",[s._v("下面的例子，不能用在测试机上面，笔者也直接抄下来了")]),s._v(" "),n("p",[s._v("假设系统有三个操作系统，分别安装在 "),n("code",[s._v("(hd0,1)、(hd0,2)、(hd0,3)")])]),s._v(" "),n("ul",[n("li",[n("code",[s._v("(hd0,1)")]),s._v("：所有人都可以进入")]),s._v(" "),n("li",[n("code",[s._v("(hd0,2)")]),s._v("：只有系统管理员可进入的系统")]),s._v(" "),n("li",[n("code",[s._v("(hd0,3)")]),s._v("：另一个一般用户与管理员可以进入的系统")])]),s._v(" "),n("p",[s._v("系统管理员账户密码设置为 "),n("code",[s._v("mrcode/123456")]),s._v("，一般账户为 "),n("code",[s._v("mrcode2/456789")])]),s._v(" "),n("p",[s._v("如上的需求，没有用到 Linux 的 linux16 与 initrd16 的项目，只需要 chainloader 的项目，因此，整个 grub.cfg 类似如下内容")]),s._v(" "),n("div",{staticClass:"language-bash line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 1. 先设置好管理员与一般账户的名称与密码")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("set")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("superusers")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'mrcode'")]),s._v("\t\t"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 管理员账户名")]),s._v("\npassword mrcode "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("123456")]),s._v("\t\t"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 设置账户名和密码")]),s._v("\npassword mrcode2 "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("456789")]),s._v("\t\t"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 一般账户名密码")]),s._v("\n\nmenuentry "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"大家都可以选择开机"')]),s._v(" --unrestricted"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n\t"),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("set")]),s._v(" root"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("hd0,1"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\tchainloader +1\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\nmenuentry "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"只有管理员的密码才有办法使用"')]),s._v(" --users "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('""')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n\t"),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("set")]),s._v(" root"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("hd0,1"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\tchainloader +1\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 可以看到这里使用 --users 声明了 mrcode2 账户")]),s._v("\nmenuentry "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"只有管理员与  mrcode2 才可以使用"')]),s._v(" --users mrcode2 "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n\t"),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("set")]),s._v(" root"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("hd0,3"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\tchainloader +1\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br")])]),n("p",[s._v("如上所示：使用 superusers 声明管理员账户，使用 password 来设置账户密码，密码有以下两种")]),s._v(" "),n("ul",[n("li",[s._v("password_pbkdf2 账户 「使用 grub2-mkpasswd-pbkdf2 所产生的密码」")]),s._v(" "),n("li",[s._v("password 账号「 没有加密的明文密码」")])]),s._v(" "),n("p",[s._v("上面的内容不要手动去修改 grub.cfg 文件，而是放到相关环境配置文件下，下面开始讲解")]),s._v(" "),n("h3",{attrs:{id:"grub2-密码设置的文件位置与加密密码"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#grub2-密码设置的文件位置与加密密码"}},[s._v("#")]),s._v(" grub2 密码设置的文件位置与加密密码")]),s._v(" "),n("p",[s._v("前几小节讲到主要的环境设置在 "),n("code",[s._v("/etc/grub.d/*")]),s._v(" 里面有一个 "),n("code",[s._v("00_header")]),s._v(" 文件，但是不建议修改它，所以可以自己建立一个 "),n("code",[s._v("01_user")]),s._v(" 的文件，要注意是两个数字开头的前缀才可以，表示优先级被读取的顺序")]),s._v(" "),n("div",{staticClass:"language-bash line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 1. 先获取两个账户的加密密码")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@study ~"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# grub2-mkpasswd-pbkdf2 ")]),s._v("\nEnter password: \nReenter password: \nPBKDF2 "),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("hash")]),s._v(" of your password is grub.pbkdf2.sha512.10000.DB145873C4E3C7ACD4A549416F8F15751EBC79D6C91F78356239AB277D0A0D89790F7CF98EA8C435ACD51C019D36AF945FCE41228AD8B0C43055ADCE4A61D7E4.37ABF2CA07512796ED302DF38C9C0CC7E407B16E5B656E49770F89E65CC590EC2F30E9160237FEE6F520D1EBACA97A7160D576B33F58AFEFE50857A849DFA8E6\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 这个加密密码可真长")]),s._v("\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 2. 将密码与账户写入到 01_users 文件内")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@study ~"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# vim /etc/grub.d/01_users")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("cat")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<<")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("eof\nset superusers='mrcode'\t\t\npassword_pbkdf2 mrcode grub.pbkdf2.sha512.10000.DB145873C4E3C7ACD4A5...\npassword_pbkdf2 mrcode2 grub.pbkdf2.sha512.10000.DB145873C4E3C7ACD4A5x...\t\t\neof")]),s._v("\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 特别注意，因为 /etc/grub.d/ 下的文件应该是执行文件")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 所以不能直接写账户密码，而是通过 cat 或 echo 等指令方式将密码数据显示出来")]),s._v("\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 3. 因为是执行文件，给执行权限")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@study ~"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# chmod a+x  /etc/grub.d/01_users")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br")])]),n("h3",{attrs:{id:"为个别的选单设置账户密码的使用模式"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#为个别的选单设置账户密码的使用模式"}},[s._v("#")]),s._v(" 为个别的选单设置账户密码的使用模式")]),s._v(" "),n("p",[s._v("回写之前的设置，目前测试机器的 Linux 系统选单应该有 5 个：")]),s._v(" "),n("ul",[n("li",[s._v("来自 "),n("code",[s._v("/etc/grub.d/10_linux")]),s._v("  文件主动检测到的两个 menuentry")]),s._v(" "),n("li",[s._v("来自 "),n("code",[s._v("/etc/grub.d/40_custom")]),s._v(" 文件我们自己主动设置的三个 menuentry")])]),s._v(" "),n("p",[s._v("由于上述在 "),n("code",[s._v("/etc/grub.d/01_users")]),s._v(" 设置了管理员，那么只有知道管理员密码的情况下，才可以修改每个选单内的参数等信息了")]),s._v(" "),n("p",[s._v("设置 10_linux 制作出来的 menuentry 的选单，正常开机，所以不要使用密码，设置如下")]),s._v(" "),n("div",{staticClass:"language-bash line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@study ~"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# vim /etc/grub.d/10_linux ")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("CLASS")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"--class gnu-linux --class gnu --class os --unrestricted"')]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 上述配置是该文件默认就有的配置")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v('# --unrestricted 不受限制，如果要受限制可将 --unrestricted 修改为 --users "账户名称"')]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 默认选单的我们建议不修改")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br")])]),n("p",[s._v("现在假设需要在 "),n("code",[s._v("40_custom")]),s._v(" 里，添加一个可以进入救援模式 rescue 的环境，并且放到最后一个选单中，同时只有知道 mrcode2 的密码才可以使用，应该这样做")]),s._v(" "),n("div",{staticClass:"language-bash line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@study ~"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# vim /etc/grub.d/40_custom")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v("\nmenuentry "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'Rescue CentOS7,with Linux 3.xx'")]),s._v(" --users mrcode2 "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        load_video\n        "),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("set")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("gfxpayload")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("keep\n        insmod gzio\n        insmod part_gpt\n        insmod xfs\n        "),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("set")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("root")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'hd0,gpt2'")]),s._v("\n        "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v(" x"),n("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$feature_platform_search_hint")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" xy "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("then")]),s._v("\n          search --no-floppy --fs-uuid --set"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("root --hint-bios"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("hd0,gpt2 --hint-efi"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("hd0,gpt2 --hint-baremetal"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("ahci0,gpt2  13d0663f-4cbd-412d-aa9f-975eb18da590\n        "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("else")]),s._v("\n          search --no-floppy --fs-uuid --set"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("root 13d0663f-4cbd-412d-aa9f-975eb18da590\n        "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("fi")]),s._v("\n        linux16 /vmlinuz-3.10.0-1062.el7.x86_64 "),n("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("root")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("/dev/mapper/centos-root ro "),n("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("crashkernel")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("auto "),n("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("spectre_v2")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("retpoline rd.lvm.lv"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("centos/root rd.lvm.lv"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("centos/swap rhgb quiet "),n("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("elevator")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("deadline systemd.unit"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("rescue.target  "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 这里配置救援环境")]),s._v("\n        initrd16 /initramfs-3.10.0-1062.el7.x86_64.img\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@study ~"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# grub2-mkconfig -o /boot/grub2/grub.cfg")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br")])]),n("p",[s._v("上面由于太多笔者没有跟着敲，导致这里设置开机选单也有不生效，感觉这一章是全军覆没了")]),s._v(" "),n("h3",{attrs:{id:"设置fallback模式"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#设置fallback模式"}},[s._v("#")]),s._v(" 设置fallback模式")]),s._v(" "),n("p",[s._v("GRUB支持一种备用机制，如果默认的启动项失败，它可以引导一个或多个其他项。如果需要的话，您可以指定多个备用项。")]),s._v(" "),n("p",[s._v("假设您有三个系统，A'、B'和C'。A'是您默认希望引导的系统。B'是一个备份系统，应该可以安全引导。C'是另一个备份系统，在`B'无法正常引导时使用。")]),s._v(" "),n("p",[s._v("那么您可能希望GRUB引导A'、B'和`C'中可引导的第一个系统。可以按以下方式编写配置文件：")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("     default saved        # This is important!!!\n     timeout 10\n     fallback 1 2         # This is important!!!\n     \n     title A\n     root (hd0,0)\n     kernel /kernel\n     savedefault fallback # This is important!!!\n     \n     title B\n     root (hd1,0)\n     kernel /kernel\n     savedefault fallback # This is important!!!\n     \n     title C\n     root (hd2,0)\n     kernel /kernel\n     savedefault\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br")])]),n("p",[s._v("请注意，配置文件中使用了default saved',fallback 1 2'和`savedefault fallback'。在这个配置中，GRUB默认引导一个已保存的项，并将一个备用项保存为下一个引导项。")]),s._v(" "),n("p",[s._v("当GRUB尝试引导A'时，GRUB将1'保存为下一个引导项，因为fallback命令指定1'是第一个备用项。而1'对应的是B'，所以GRUB将在下一次引导时尝试引导B'。")]),s._v(" "),n("p",[s._v("同样地，当GRUB尝试引导B'时，GRUB将2'保存为下一个引导项，因为fallback指定2'作为下一个备用项。这确保在引导B'后，GRUB将引导`C'。")]),s._v(" "),n("p",[s._v("值得注意的是，无论是在GRUB本身引导项失败还是在A'或B'启动您的系统失败时，GRUB都会使用备用项。因此，这个解决方案确保即使GRUB找不到您的内核或内核发生崩溃，您的系统也能够启动。")]),s._v(" "),n("p",[s._v("然而，当A'正确启动或您修复A'后，您需要运行grub-set-default，因为GRUB始终将下一个引导项设置为备用项。您可以在启动脚本（如rc.local）中运行这个命令来将`A'设置为默认引导项：")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("     # grub-set-default 0\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])]),n("p",[s._v("这里的0'是系统A'的引导项号码。")]),s._v(" "),n("p",[s._v("如果您想查看当前的默认引导项，可以查看文件/boot/grub/default（或某些系统中的/grub/default）。由于该文件是纯文本文件，您可以直接使用cat命令查看。但强烈建议不要直接修改该文件，因为如果您以意外的方式更改该文件，GRUB可能无法保存默认引导项在该文件中。因此，当您需要更改默认引导项时，请使用grub-set-default命令。")])])}),[],!1,null,null,null);t.default=e.exports}}]);