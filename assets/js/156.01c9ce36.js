(window.webpackJsonp=window.webpackJsonp||[]).push([[156],{671:function(a,s,t){"use strict";t.r(s);var e=t(16),n=Object(e.a)({},(function(){var a=this,s=a.$createElement,t=a._self._c||s;return t("ContentSlotsDistributor",{attrs:{"slot-key":a.$parent.slotKey}},[t("h1",{attrs:{id:"备份的种类、频率、与工具的选择"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#备份的种类、频率、与工具的选择"}},[a._v("#")]),a._v(" 备份的种类、频率、与工具的选择")]),a._v(" "),t("p",[a._v("备份的种类粗了分为：累积备份、差异备份。如果仅想在系统出错时重新安装到更新的系统时，仅备份关键数据也可以")]),a._v(" "),t("h2",{attrs:{id:"完整备份之累积备份（incremental-backup）"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#完整备份之累积备份（incremental-backup）"}},[a._v("#")]),a._v(" 完整备份之累积备份（Incremental backup）")]),a._v(" "),t("p",[a._v("笔者个人觉得，关于要如何备份，要看你的需求，这里讲解每种备份的一些思路与思考")]),a._v(" "),t("h3",{attrs:{id:"还原考虑"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#还原考虑"}},[a._v("#")]),a._v(" 还原考虑")]),a._v(" "),t("p",[a._v("如果是完整备份的话，可以直接备份 "),t("code",[a._v("/")]),a._v(" 根目录下的所有文件，还原时也是全部还原，这个是很快速方便的，还可以备份一个文件系统，例如 "),t("code",[a._v("/dev/sda1")])]),a._v(" "),t("h3",{attrs:{id:"累积备份的原则（增量备份）"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#累积备份的原则（增量备份）"}},[a._v("#")]),a._v(" 累积备份的原则（增量备份）")]),a._v(" "),t("p",[a._v("累积备份：系统先进行一次完整数据备份之后，下次再备份仅备份有变化的数据。")]),a._v(" "),t("p",[a._v("这样备份规则数据量小且快速，备份很有效率")]),a._v(" "),t("p",[a._v("如何还原？由于是增量备份，当还原的时候需要从第一次备份开始以此还原")]),a._v(" "),t("h3",{attrs:{id:"累积备份使用的备份软件"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#累积备份使用的备份软件"}},[a._v("#")]),a._v(" 累积备份使用的备份软件")]),a._v(" "),t("p",[a._v("完整备份常用的工具有 dd、cpio、xfsdump、xfsrestor 等。因为这些工具都能备份设备与特殊文件")]),a._v(" "),t("ul",[t("li",[a._v("dd 可以直接读取磁盘扇区而不管文件系统，缺点就是有点慢")]),a._v(" "),t("li",[a._v("cpio 能备份所有的文件，但是需要 find 或其他找文件名的指令才能处理")])]),a._v(" "),t("p",[a._v("以上两个都可以完整备份，但累计备份就要额外的使用脚本程序来处理。")]),a._v(" "),t("p",[a._v("xfsdump 可以直接完成累积备份，这部分知识在第 8 章有讲解")]),a._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 1. 用 dd 将 /dev/sda 备份到完全一模一样的 /dev/sdb 硬盘上")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token function"}},[a._v("dd")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[a._v("if")]),t("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v("/dev/sda "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[a._v("of")]),t("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v("/dev/sdb\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 由于是直接读取扇区，所以  /dev/sdb 磁盘可以不用格式化")]),a._v("\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 2. 使用 cpio 来备份还原整个系统，假设存储媒体为 SATA 磁带机")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token function"}},[a._v("find")]),a._v(" / -print "),t("span",{pre:!0,attrs:{class:"token operator"}},[a._v("|")]),a._v(" cpio -covB "),t("span",{pre:!0,attrs:{class:"token operator"}},[a._v(">")]),a._v(" /dev/st0  "),t("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 备份到磁带机")]),a._v("\ncpio -iduv "),t("span",{pre:!0,attrs:{class:"token operator"}},[a._v("<")]),a._v(" /dev/st0\t\t"),t("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 还原")]),a._v("\n")])]),a._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[a._v("1")]),t("br"),t("span",{staticClass:"line-number"},[a._v("2")]),t("br"),t("span",{staticClass:"line-number"},[a._v("3")]),t("br"),t("span",{staticClass:"line-number"},[a._v("4")]),t("br"),t("span",{staticClass:"line-number"},[a._v("5")]),t("br"),t("span",{staticClass:"line-number"},[a._v("6")]),t("br"),t("span",{staticClass:"line-number"},[a._v("7")]),t("br")])]),t("p",[a._v("假设 "),t("code",[a._v("/home")]),a._v(" 是一个独立的文件系统，而 "),t("code",[a._v("/backupdata")]),a._v(" 也是一个独立的用来备份的文件系统，如何使用 dump 将 "),t("code",[a._v("/home")]),a._v(" 完整备份到 /backupdata 呢?")]),a._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 1. 完整备份")]),a._v("\nxfsdump -l "),t("span",{pre:!0,attrs:{class:"token number"}},[a._v("0")]),a._v(" -L "),t("span",{pre:!0,attrs:{class:"token string"}},[a._v("'full'")]),a._v(" -M -f /backupdata/home.dump /home\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 2. 第一次进行累积备份")]),a._v("\nxfsdump -l "),t("span",{pre:!0,attrs:{class:"token number"}},[a._v("1")]),a._v(" -L ‘full-1’ -N -f /backupdata/home.dump1 /home\n")])]),a._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[a._v("1")]),t("br"),t("span",{staticClass:"line-number"},[a._v("2")]),t("br"),t("span",{staticClass:"line-number"},[a._v("3")]),t("br"),t("span",{staticClass:"line-number"},[a._v("4")]),t("br"),t("span",{staticClass:"line-number"},[a._v("5")]),t("br")])]),t("p",[a._v("ta 也可以用来进行完整备份。比如  "),t("code",[a._v("backupdata")]),a._v(" 是个独立的文件系统，想将整个系统备份起来时，可以这样考虑：将不需要备份的 "),t("code",[a._v("/proc")]),a._v("、"),t("code",[a._v("/mnt")]),a._v("、"),t("code",[a._v("/tmp")]),a._v(" 等目录不备份，其他的数据则备份")]),a._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[t("span",{pre:!0,attrs:{class:"token function"}},[a._v("tar")]),a._v(" -exclude /proc --exclude /mnt --exclude /tmp --exclude /backupdata -jcvp /backupdata/system.tar.bz2\n")])]),a._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[a._v("1")]),t("br")])]),t("h2",{attrs:{id:"完整备份之差异备份（differential-backup）"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#完整备份之差异备份（differential-backup）"}},[a._v("#")]),a._v(" 完整备份之差异备份（Differential backup）")]),a._v(" "),t("p",[a._v("差异备份：与累积备份类似，第一次需要完整备份，后面的每次备份都是以第一次作为基准的差异备份。所以系统运行越久，离完整备份时间越长，那么该次的差异备份数据可能就会越大")]),a._v(" "),t("p",[a._v("差异备份与累积备份的常用工具类似，因为都需要完整备份，如果使用 xfsdump 来备份的话，那么每次备份的等级（level） 就都是 level 1 。")]),a._v(" "),t("p",[a._v("当使用 tar 的时候，可以使用 -N 选项来备份")]),a._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[t("span",{pre:!0,attrs:{class:"token function"}},[a._v("tar")]),a._v(" -N ‘2020-04-04’ -jpcv -f /backupdata/home.tar.bz2 /home\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 只有在比 2020-04-04 还要新的文件时，在 /home 下的文件才会被打包进 home.tar.bz2 中")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 有一点不好就是，目录会被备份进来，只是目录内的旧文件不会备份")]),a._v("\n")])]),a._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[a._v("1")]),t("br"),t("span",{staticClass:"line-number"},[a._v("2")]),t("br"),t("span",{staticClass:"line-number"},[a._v("3")]),t("br")])]),t("p",[a._v("另外还可以通过 rsync 来进行镜像备份。rsync 可以对两个目录进行镜像（mirror），算是一个非常快速的备份工具，简单指令语法 "),t("code",[a._v("rsync -av 来源目录 目标目录")])]),a._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 1. 将 /home/ 镜像到 /backupdata/home/ ")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token function"}},[a._v("rsync")]),a._v(" -av /home /backupdata/\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 此时会在 /backupdata 下产生 home 目录")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token function"}},[a._v("rsync")]),a._v(" -av /home /backupdata/\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 再次执行就会快很多，如果数据没有改变，几乎不会进行任何动作")]),a._v("\n\n")])]),a._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[a._v("1")]),t("br"),t("span",{staticClass:"line-number"},[a._v("2")]),t("br"),t("span",{staticClass:"line-number"},[a._v("3")]),t("br"),t("span",{staticClass:"line-number"},[a._v("4")]),t("br"),t("span",{staticClass:"line-number"},[a._v("5")]),t("br"),t("span",{staticClass:"line-number"},[a._v("6")]),t("br")])]),t("p",[a._v("差异备份所使用的磁盘容量可能会比累积备份更大，但是差异备份还原较快")]),a._v(" "),t("h2",{attrs:{id:"关键数据备份"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#关键数据备份"}},[a._v("#")]),a._v(" 关键数据备份")]),a._v(" "),t("p",[a._v("完整备份虽然有很多好处，但是需要花费很多时间，在某些场景下只需要备份重要文件即可，比如你的主机不是一定要 24 小时提供的服务，就算宕机两三天，可能也不会影响到你的正常生活时。")]),a._v(" "),t("p",[a._v("关机数据备份也有一些好处：比如完整备份是在系统运行期间，如果系统本身就有问题了，就算还原回去，还是有问题的")]),a._v(" "),t("p",[a._v("对于关机数据的备份，对于还原稍微难一点，你需要很熟悉系统的运作，尤其是 SELinux 等安全行管的权限等问题时。")]),a._v(" "),t("p",[a._v("作者在备份关键数据时喜欢使用 tar + date 来配合")]),a._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[t("span",{pre:!0,attrs:{class:"token function"}},[a._v("tar")]),a._v(" -jpcvf mysql."),t("span",{pre:!0,attrs:{class:"token variable"}},[t("span",{pre:!0,attrs:{class:"token variable"}},[a._v("`")]),t("span",{pre:!0,attrs:{class:"token function"}},[a._v("date")]),a._v(" +%y-%m-%d"),t("span",{pre:!0,attrs:{class:"token variable"}},[a._v("`")])]),a._v(".tar.bz2 /var/mysql\n")])]),a._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[a._v("1")]),t("br")])]),t("p",[a._v("备份是非常重要的工作，你可以编写脚本配合 crontab 去执行")])])}),[],!1,null,null,null);s.default=n.exports}}]);